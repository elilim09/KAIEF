<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>KAIEF â€“ ëŒ€í•œë¯¼êµ­ í–‰ì‚¬ AI íŒŒì¸ë”</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Material 3 Expressive-friendly fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght,GRAD,slnt,YOPQ@8..144,300..900,-200..150,-12..0,25..135&family=Noto+Sans+KR:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --seed-primary:  #6366F1;
      --seed-secondary:#06B6D4;
      --seed-tertiary: #10B981;

      --md-sys-color-primary: var(--seed-primary);
      --md-sys-color-on-primary: #FFFFFF;
      --md-sys-color-primary-container: #E0E7FF;
      --md-sys-color-on-primary-container: #1E1B4B;

      --md-sys-color-secondary: #64748B;
      --md-sys-color-on-secondary: #FFFFFF;
      --md-sys-color-secondary-container: #E2F6FA;
      --md-sys-color-on-secondary-container: #07242B;

      --md-sys-color-tertiary:  var(--seed-tertiary);
      --md-sys-color-on-tertiary:#FFFFFF;
      --md-sys-color-tertiary-container:#D1FAE5;
      --md-sys-color-on-tertiary-container:#064E3B;

      --md-sys-color-error:#DC2626;
      --md-sys-color-on-error:#FFFFFF;
      --md-sys-color-error-container:#FEE2E2;
      --md-sys-color-on-error-container:#7F1D1D;

      --md-sys-color-surface: #FAFBFC;
      --md-sys-color-on-surface: #0F172A;
      --md-sys-color-surface-dim: #EFF2F6;
      --md-sys-color-surface-bright: #FFFFFF;
      --md-sys-color-surface-container-lowest: #FFFFFF;
      --md-sys-color-surface-container-low: #F8FAFC;
      --md-sys-color-surface-container: #F1F5F9;
      --md-sys-color-surface-container-high: #E2E8F0;
      --md-sys-color-surface-container-highest: #CBD5E1;

      --md-sys-color-outline: #CBD5E1;
      --md-sys-color-outline-variant: #E2E8F0;

      --shape-corner-xs: 4px;
      --shape-corner-sm: 8px;
      --shape-corner-md: 12px;
      --shape-corner-lg: 16px;
      --shape-corner-xl: 28px;
      --shape-corner-2xl: 48px;
      --shape-corner-full: 9999px;

      --easing-standard: cubic-bezier(0.2, 0, 0, 1);
      --easing-emphasized: cubic-bezier(0.05, 0.7, 0.1, 1);
      --easing-expressive: cubic-bezier(0.25, 0.8, 0.2, 1);
      --dur-quick: 140ms;
      --dur-standard: 220ms;
      --dur-long: 360ms;

      --elevation-1: 0 1px 2px rgba(0,0,0,0.06);
      --elevation-2: 0 4px 8px rgba(0,0,0,0.08);
      --elevation-3: 0 8px 16px rgba(0,0,0,0.10);
      --elevation-4: 0 16px 24px rgba(0,0,0,0.12);
      --elevation-5: 0 24px 40px rgba(0,0,0,0.16);

      --gradient-primary: linear-gradient(135deg, #6366F1 0%, #8B5CF6 50%, #A855F7 100%);
      --gradient-surface: linear-gradient(180deg, var(--md-sys-color-surface) 0%, var(--md-sys-color-surface-container-low) 100%);
    }

    [data-theme="dark"] {
      --md-sys-color-primary: #818CF8;
      --md-sys-color-on-primary: #1E1B4B;
      --md-sys-color-primary-container: #312E81;
      --md-sys-color-on-primary-container: #E0E7FF;

      --md-sys-color-secondary: #94A3B8;
      --md-sys-color-on-secondary: #0B1220;
      --md-sys-color-secondary-container: #101826;
      --md-sys-color-on-secondary-container: #E5EEF7;

      --md-sys-color-tertiary: #34D399;
      --md-sys-color-on-tertiary: #052016;
      --md-sys-color-tertiary-container: #0B3B2B;
      --md-sys-color-on-tertiary-container: #D1FAE5;

      --md-sys-color-surface: #0F172A;
      --md-sys-color-on-surface: #F1F5F9;
      --md-sys-color-surface-dim: #0B1426;
      --md-sys-color-surface-bright: #162036;
      --md-sys-color-surface-container-lowest: #0A1222;
      --md-sys-color-surface-container-low: #0E1729;
      --md-sys-color-surface-container: #1C2540;
      --md-sys-color-surface-container-high: #293351;
      --md-sys-color-surface-container-highest: #364166;

      --md-sys-color-outline: #334155;
      --md-sys-color-outline-variant: #1E293B;

      --gradient-surface: linear-gradient(180deg, #0F172A 0%, #1E293B 100%);
    }

    html, body { height: 100%; }
    body {
      font-family: 'Roboto Flex', 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      background: var(--gradient-surface);
      color: var(--md-sys-color-on-surface);
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app { width: min(430px, 100vw); min-height: 100dvh; margin: 0 auto; position: relative; }

    .app-bar { position: sticky; top: 0; z-index: 30; background: var(--md-sys-color-surface); backdrop-filter: saturate(1.3) blur(10px); border-bottom: 1px solid var(--md-sys-color-outline-variant); transition: padding var(--dur-standard) var(--easing-emphasized), box-shadow var(--dur-standard) var(--easing-standard); padding: 18px 20px 12px; }
    .app-bar.compact { padding: 8px 16px; box-shadow: var(--elevation-1); }
    .brand { display:flex; align-items:center; gap:12px; }
    .brand-badge { width: 36px; height: 36px; border-radius: var(--shape-corner-xl); background: var(--gradient-primary); display:flex; align-items:center; justify-content:center; color:#fff; box-shadow: var(--elevation-2); }
    .brand-title { font-weight: 800; letter-spacing: -0.02em; }
    .brand-title .large { font-size: 20px; background: var(--gradient-primary); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .brand-title .small { font-size: 16px; opacity: .9; display:none; }
    .app-bar.compact .brand-title .large { display:none; }
    .app-bar.compact .brand-title .small { display:inline-block; }
    .control-cluster { display:flex; align-items:center; gap:10px; }
    .lang-toggle { display:flex; background: var(--md-sys-color-surface-container-low); padding:4px; border-radius: var(--shape-corner-full); border:1px solid var(--md-sys-color-outline-variant); box-shadow: var(--elevation-1); }
    .lang-toggle button { border:0; background:transparent; padding:6px 12px; border-radius: var(--shape-corner-full); font-size:12px; font-weight:600; color: color-mix(in oklab, var(--md-sys-color-on-surface) 80%, transparent); cursor:pointer; transition: background var(--dur-quick) var(--easing-standard), color var(--dur-quick) var(--easing-standard); }
    .lang-toggle button.active { background: var(--gradient-primary); color: var(--md-sys-color-on-primary); box-shadow: var(--elevation-2); }
    .hero { margin-top: 16px; }
    .hero p { margin: 0; line-height: 1.6; font-size: 14px; color: color-mix(in oklab, var(--md-sys-color-on-surface) 80%, transparent); }
    .hero-pills { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .service-pill { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius: var(--shape-corner-full); font-size:12px; font-weight:600; background: var(--md-sys-color-surface-container); border:1px solid var(--md-sys-color-outline-variant); color: color-mix(in oklab, var(--md-sys-color-on-surface) 90%, transparent); }
    .view-tabs { margin-top: 18px; display:flex; gap:8px; background: var(--md-sys-color-surface-container-low); padding:6px; border-radius: var(--shape-corner-full); border:1px solid var(--md-sys-color-outline-variant); }
    .view-tabs button { flex:1; border:0; border-radius: var(--shape-corner-full); padding:10px 0; font-weight:600; font-size:13px; background:transparent; color: color-mix(in oklab, var(--md-sys-color-on-surface) 75%, transparent); cursor:pointer; transition: background var(--dur-quick) var(--easing-standard), color var(--dur-quick) var(--easing-standard), transform var(--dur-quick) var(--easing-standard); }
    .view-tabs button.active { background: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); box-shadow: var(--elevation-1); transform: translateY(-1px); }
    .view { display:none; }
    .view.active { display:flex; }
    .chat { height: calc(100dvh - 72px); display:flex; flex-direction:column; background: var(--md-sys-color-surface); }
    .feed { flex-direction:column; background: var(--md-sys-color-surface); }
    .feed-inner { flex:1; overflow-y:auto; padding: 18px 20px 32px; display:flex; flex-direction:column; gap:18px; }
    .feed-intro { background: var(--md-sys-color-surface-container); border-radius: var(--shape-corner-xl); padding:18px; border:1px solid var(--md-sys-color-outline-variant); box-shadow: var(--elevation-1); }
    .feed-intro h2 { font-size:18px; margin:0 0 8px; letter-spacing:-0.01em; }
    .feed-intro p { margin:0; font-size:14px; line-height:1.6; color: color-mix(in oklab, var(--md-sys-color-on-surface) 78%, transparent); }
    .feed-controls { background: var(--md-sys-color-surface-container-low); border-radius: var(--shape-corner-xl); padding:16px; border:1px solid var(--md-sys-color-outline-variant); display:flex; flex-direction:column; gap:16px; }
    .feed-controls strong { font-size:13px; color: color-mix(in oklab, var(--md-sys-color-on-surface) 80%, transparent); }
    .filter-row { display:flex; flex-wrap:wrap; gap:8px; }
    .filter-chip { border-radius: var(--shape-corner-full); border:1px solid var(--md-sys-color-outline-variant); padding:8px 14px; font-size:13px; font-weight:500; cursor:pointer; background: var(--md-sys-color-surface); transition: all var(--dur-quick) var(--easing-standard); }
    .filter-chip.active { background: var(--gradient-primary); border-color: transparent; color: var(--md-sys-color-on-primary); box-shadow: var(--elevation-2); }
    .feed-insights { background: var(--md-sys-color-surface-container); border-radius: var(--shape-corner-xl); padding:18px; border:1px solid var(--md-sys-color-outline-variant); box-shadow: var(--elevation-1); display:flex; flex-direction:column; gap:12px; }
    .feed-insights h3 { margin:0; font-size:16px; }
    .insight-list { display:flex; flex-direction:column; gap:8px; font-size:13px; color: color-mix(in oklab, var(--md-sys-color-on-surface) 85%, transparent); }
    .feed-list { display:flex; flex-direction:column; gap:14px; }
    .feed-card { border-radius: var(--shape-corner-xl); border:1px solid var(--md-sys-color-outline-variant); background: var(--md-sys-color-surface); padding:16px; box-shadow: var(--elevation-1); display:flex; flex-direction:column; gap:12px; }
    .feed-card h3 { margin:0; font-size:15px; letter-spacing:-0.01em; }
    .feed-card .meta { display:flex; flex-wrap:wrap; gap:10px; font-size:13px; color: color-mix(in oklab, var(--md-sys-color-on-surface) 85%, transparent); }
    .feed-card .meta span { display:flex; align-items:center; gap:4px; }
    .feed-card a { align-self:flex-end; font-size:13px; font-weight:600; color: var(--md-sys-color-primary); text-decoration:none; display:inline-flex; align-items:center; gap:6px; }
    .empty-feed { border-radius: var(--shape-corner-xl); border:1px dashed var(--md-sys-color-outline-variant); background: color-mix(in oklab, var(--md-sys-color-surface-container) 70%, transparent); padding:24px; text-align:center; font-size:14px; color: color-mix(in oklab, var(--md-sys-color-on-surface) 75%, transparent); }
    .hidden { display:none !important; }

    .icon-button { width: 40px; height: 40px; border-radius: var(--shape-corner-lg); display:grid; place-items:center; border:1px solid var(--md-sys-color-outline-variant); background: var(--md-sys-color-surface-container-low); color: var(--md-sys-color-on-surface); transition: transform var(--dur-quick) var(--easing-standard), background var(--dur-quick) var(--easing-standard); }
    .icon-button:hover { transform: translateY(-1px); background: var(--md-sys-color-surface-container); }
    .icon-button:active { transform: scale(.97); }
    .theme-toggle { background: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container); border-color: transparent; }

    .popover { position:absolute; right: 16px; top: 60px; width: 280px; padding: 12px; border-radius: var(--shape-corner-xl); background: var(--md-sys-color-surface-container); border:1px solid var(--md-sys-color-outline-variant); box-shadow: var(--elevation-4); transform-origin: top right; opacity:0; transform: scale(.96); pointer-events:none; transition: opacity var(--dur-standard) var(--easing-standard), transform var(--dur-standard) var(--easing-emphasized); }
    .popover.open { opacity:1; transform: scale(1); pointer-events:auto; }
    .chip { padding:8px 14px; border-radius: var(--shape-corner-full); font-size:13px; font-weight:500; cursor:pointer; border:1px solid var(--md-sys-color-outline-variant); background: var(--md-sys-color-surface-container-low); color: var(--md-sys-color-on-surface); transition: transform var(--dur-quick) var(--easing-standard), background var(--dur-quick) var(--easing-standard), border-color var(--dur-quick) var(--easing-standard); }
    .chip:hover{ transform: translateY(-1px); background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); border-color: var(--md-sys-color-primary); }

    .chat-list { flex:1; padding: 14px 20px; overflow-y:auto; scroll-behavior:smooth; }
    .chat-list::-webkit-scrollbar{ width:6px; } .chat-list::-webkit-scrollbar-thumb{ background: var(--md-sys-color-outline); border-radius:3px; }

    .bubble{ max-width:82%; line-height:1.55; font-size:15px; padding:14px 16px; border-radius: var(--shape-corner-xl); position:relative; animation: slideUp var(--dur-standard) var(--easing-emphasized); }
    .bubble.assistant{ background: var(--md-sys-color-surface-container); color: var(--md-sys-color-on-surface); border:1px solid var(--md-sys-color-outline-variant); border-bottom-left-radius: var(--shape-corner-sm); }
    .bubble.user{ background: var(--gradient-primary); color: var(--md-sys-color-on-primary); margin-left:auto; box-shadow: var(--elevation-2); border-bottom-right-radius: var(--shape-corner-sm); }
    @keyframes slideUp { from { opacity:0; transform: translateY(16px) scale(.98); } to { opacity:1; transform: translateY(0) scale(1); } }

    .composer { padding: 10px 12px 14px; border-top: 1px solid var(--md-sys-color-outline-variant); background: var(--md-sys-color-surface); position:relative; z-index: 10; }
    .composer-row { display:flex; gap:10px; align-items:flex-end; }

    .field { flex:1; display:flex; align-items:center; background: var(--md-sys-color-surface-container); border: 2px solid var(--md-sys-color-outline-variant); border-radius: var(--shape-corner-full); transition: border-color var(--dur-quick) var(--easing-standard), box-shadow var(--dur-quick) var(--easing-standard), background var(--dur-quick) var(--easing-standard); padding: 2px 6px; position:relative; }
    .field:focus-within{ border-color: var(--md-sys-color-primary); box-shadow: 0 0 0 4px color-mix(in oklab, var(--md-sys-color-primary) 20%, transparent); background: var(--md-sys-color-surface-container-high); }
    .input{ flex:1; border:0; outline:0; background: transparent; color: var(--md-sys-color-on-surface); font-size: 15px; padding: 10px 10px; }
    .input::placeholder{ color: color-mix(in oklab, var(--md-sys-color-on-surface) 55%, transparent); }

    .send { height:56px; min-width:56px; border-radius: var(--shape-corner-full); border:0; cursor:pointer; color:var(--md-sys-color-on-primary); background: var(--gradient-primary); display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:0 18px; box-shadow: var(--elevation-3); transition: width var(--dur-standard) var(--easing-emphasized), padding var(--dur-standard) var(--easing-emphasized), transform var(--dur-quick) var(--easing-standard), box-shadow var(--dur-quick) var(--easing-standard); }
    .send:hover{ box-shadow: var(--elevation-5); transform: translateY(-2px); }
    .send:active{ transform: translateY(0) scale(.985); transition-duration: 90ms; }
    .send[data-compact="true"]{ width:56px; padding:0; }
    .send .label{ white-space:nowrap; overflow:hidden; max-width:0; opacity:0; transition: max-width var(--dur-standard) var(--easing-emphasized), opacity var(--dur-standard) var(--easing-standard); }
    .send[data-compact="false"] .label{ max-width:120px; opacity:1; }
    .send svg { display: block; }
    .send[data-compact="true"] { gap: 0; }
    .send .label { line-height: 1; margin: 0; }

    /* ======= Reworked FAB Speed Dial (anchored to more button) ======= */
    .fab-dial { position:absolute; right: 0; bottom: 56px; display:flex; flex-direction:column; gap:10px; transform-origin: bottom right; pointer-events:none; }
    .fab-dial.open { pointer-events:auto; }
    .mini-fab { position:relative; width:48px; height:48px; border-radius: var(--shape-corner-full); display:grid; place-items:center; border:1px solid var(--md-sys-color-outline-variant); background: var(--md-sys-color-surface-container); color: var(--md-sys-color-on-surface); box-shadow: var(--elevation-3); transform: scale(.9) translateY(8px); opacity:0; transition: transform var(--dur-standard) var(--easing-emphasized), opacity var(--dur-standard) var(--easing-standard); }
    .fab-dial.open .mini-fab { transform: scale(1) translateY(0); opacity:1; }
    .mini-fab:nth-child(1){ transition-delay: 20ms; } .mini-fab:nth-child(2){ transition-delay: 60ms; } .mini-fab:nth-child(3){ transition-delay: 100ms; }
    .mini-fab:focus-visible{ outline: 3px solid color-mix(in oklab, var(--md-sys-color-primary) 45%, transparent); }
    .fab-label { position:absolute; right: 54px; top:50%; transform: translateY(-50%); padding:6px 10px; border-radius: var(--shape-corner-full); font-size:12px; background: var(--md-sys-color-surface-container-high); border:1px solid var(--md-sys-color-outline-variant); box-shadow: var(--elevation-2); opacity:0; pointer-events:none; transition: opacity var(--dur-quick) var(--easing-standard); }
    .mini-fab:hover .fab-label { opacity:1; }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; padding: 0 6px; }

    @keyframes blink { 0%,100%{opacity:.25} 50%{opacity:1} }
    .dots>span{ display:inline-block; width:6px; height:6px; border-radius:999px; background: currentColor; animation: blink 1s infinite; }
    .dots>span:nth-child(2){ animation-delay:.18s } .dots>span:nth-child(3){ animation-delay:.36s }

    @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition-duration: 1ms !important; } }
  </style>
</head>
<body>
  <div class="app">
    <header id="appBar" class="app-bar">
      <div class="flex items-center justify-between">
        <div class="brand">
          <div class="brand-badge" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" role="img"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
          </div>
          <div class="brand-title">
            <span class="large" data-i18n="brand.large">ëŒ€í•œë¯¼êµ­ í–‰ì‚¬ AI íŒŒì¸ë”</span>
            <span class="small" data-i18n="brand.small">KAIEF</span>
          </div>
        </div>
        <div class="control-cluster">
          <div class="lang-toggle" role="group" aria-label="Language toggle">
            <button type="button" data-locale="ko" class="active" data-i18n="lang.ko">í•œêµ­ì–´</button>
            <button type="button" data-locale="en" data-i18n="lang.en">English</button>
          </div>
          <button id="paletteBtn" class="icon-button" aria-label="ë¸Œëœë“œ ìƒ‰ ì„¤ì •">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22a5 5 0 01-5-5 7 7 0 117 7z"/><circle cx="6.5" cy="11.5" r="1.5"/><circle cx="9.5" cy="7.5" r="1.5"/><circle cx="14.5" cy="7.5" r="1.5"/><circle cx="17.5" cy="11.5" r="1.5"/></svg>
          </button>
          <button id="themeToggle" class="icon-button theme-toggle" aria-label="í…Œë§ˆ ì „í™˜">
            <svg id="sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
            <svg id="moon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"/></svg>
          </button>
        </div>
      </div>

      <div class="hero">
        <p data-i18n="hero.paragraph">ë¬¸í™”ì²´ìœ¡ê´€ê´‘ë¶€ ì‚°í•˜ êµ­ë¦½ê¸°ê´€ í–‰ì‚¬ ì •ë³´ë¥¼ AIë¡œ íë ˆì´ì…˜í•˜ê³ , ê´€ì‹¬ì‚¬ ê¸°ë°˜ ë§ì¶¤ ì¶”ì²œì„ ì œê³µí•©ë‹ˆë‹¤.</p>
        <div class="hero-pills">
          <span class="service-pill" data-i18n="hero.pill1">LLM + RAG íë ˆì´ì…˜</span>
          <span class="service-pill" data-i18n="hero.pill2">í•œêµ­ì–´ Â· English ì„œë¹„ìŠ¤</span>
          <span class="service-pill" data-i18n="hero.pill3">ì‹œë‹ˆì–´ ìŒì„± ì§ˆì˜</span>
          <span class="service-pill" data-i18n="hero.pill4">PWA & ì‹¤ì‹œê°„ í¬ë¡¤ë§</span>
        </div>
      </div>

      <nav class="view-tabs" aria-label="View switcher">
        <button type="button" class="active" data-view="chat" data-i18n="tab.chat">AI ì±—ë´‡</button>
        <button type="button" data-view="feed" data-i18n="tab.feed">í–‰ì‚¬ í”¼ë“œ</button>
      </nav>

      <div id="brandPanel" class="popover">
        <div class="text-sm font-semibold mb-2">ë¸Œëœë“œ ì»¬ëŸ¬ (ì”¨ì•—) ì„ íƒ</div>
        <div class="flex flex-wrap gap-2 mb-3">
          <button class="chip" data-seed="#6366F1">Indigo (ê¸°ë³¸)</button>
          <button class="chip" data-seed="#0EA5E9">Cyan</button>
          <button class="chip" data-seed="#10B981">Emerald</button>
          <button class="chip" data-seed="#8B5CF6">Purple</button>
        </div>
        <label class="text-sm block mb-2">ì‚¬ìš©ì ì§€ì • ìƒ‰ìƒ</label>
        <div class="flex items-center gap-3">
          <input id="customSeed" type="color" value="#6366F1" class="w-10 h-10 rounded-[12px] border border-[var(--md-sys-color-outline-variant)] bg-[var(--md-sys-color-surface-container)]"/>
          <input id="customSeedHex" type="text" value="#6366F1" class="flex-1 text-sm px-2 py-2 rounded-[10px] border border-[var(--md-sys-color-outline-variant)] bg-[var(--md-sys-color-surface-container-low)]"/>
          <button id="applySeed" class="chip">ì ìš©</button>
        </div>
      </div>
    </header>

    <main class="chat view active" id="chatView">
      <div id="chatList" class="chat-list">
        <div class="flex justify-start"><div class="bubble assistant">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-6 h-6 rounded-full" style="background:linear-gradient(90deg,#34D399,#06B6D4)"></div>
            <span class="text-xs opacity-70 font-medium" id="assistantIntroBadge" data-i18n="assistant.badge">AI ì–´ì‹œìŠ¤í„´íŠ¸</span>
          </div>
          <div id="assistantIntroText" data-i18n="assistant.intro">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‰<br/>ëŒ€í•œë¯¼êµ­ êµ­ë¦½ê¸°ê´€ì˜ ë¬¸í™”Â·ì˜ˆìˆ  í–‰ì‚¬ë¥¼ ì°¾ì•„ë“œë¦¬ëŠ” KAIEFì…ë‹ˆë‹¤. ì‹œê°„, ê´€ì‹¬ì‚¬, ì´ë™ ìˆ˜ë‹¨ì„ ì•Œë ¤ì£¼ì‹œë©´ ë§ì¶¤ ì¶”ì²œì„ ë“œë¦´ê²Œìš”.</div>
        </div></div>
      </div>

      <div class="composer">
        <div class="chips" id="chips">
          <button class="chip" data-i18n="chip.weekend" data-text="ì´ë²ˆ ì£¼ë§ì— ê°ˆ ë§Œí•œ ë¬¸í™”í–‰ì‚¬ ì¶”ì²œí•´ì¤˜" data-text-ko="ì´ë²ˆ ì£¼ë§ì— ê°ˆ ë§Œí•œ ë¬¸í™”í–‰ì‚¬ ì¶”ì²œí•´ì¤˜" data-text-en="Recommend cultural events from national institutions this weekend">ğŸª ì´ë²ˆ ì£¼ë§ ì¶”ì²œ</button>
          <button class="chip" data-i18n="chip.family" data-text="ì•„ì´ì™€ í•¨ê»˜ ì¦ê¸¸ ìˆ˜ ìˆëŠ” êµ­ë¦½ê¸°ê´€ í–‰ì‚¬ë¥¼ ì•Œë ¤ì¤˜" data-text-ko="ì•„ì´ì™€ í•¨ê»˜ ì¦ê¸¸ ìˆ˜ ìˆëŠ” êµ­ë¦½ê¸°ê´€ í–‰ì‚¬ë¥¼ ì•Œë ¤ì¤˜" data-text-en="Share family-friendly programs from national institutions">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡± ë§ì¶¤</button>
          <button class="chip" data-i18n="chip.free" data-text="ë¬´ë£Œë¡œ ê´€ëŒ ê°€ëŠ¥í•œ ì „ì‹œë¥¼ ì†Œê°œí•´ì¤˜" data-text-ko="ë¬´ë£Œë¡œ ê´€ëŒ ê°€ëŠ¥í•œ ì „ì‹œë¥¼ ì†Œê°œí•´ì¤˜" data-text-en="Find free exhibitions curated by national venues">ğŸ’¸ ë¬´ë£Œ ì „ì‹œ</button>
          <button class="chip" data-i18n="chip.global" data-text="ì™¸êµ­ì¸ ê´€ê´‘ê°ì´ ì˜ì–´ ì•ˆë‚´ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ” í–‰ì‚¬ë¥¼ ì°¾ì•„ì¤˜" data-text-ko="ì™¸êµ­ì¸ ê´€ê´‘ê°ì´ ì˜ì–´ ì•ˆë‚´ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ” í–‰ì‚¬ë¥¼ ì°¾ì•„ì¤˜" data-text-en="Which events offer English guidance for visitors?">ğŸŒ ì˜ì–´ ì•ˆë‚´ í–‰ì‚¬</button>
          <button class="chip" data-i18n="chip.gugak" data-text="êµ­ë¦½êµ­ì•…ì›ì—ì„œ ì—´ë¦¬ëŠ” ê³µì—° ì¼ì •ì„ ì•Œë ¤ì¤˜" data-text-ko="êµ­ë¦½êµ­ì•…ì›ì—ì„œ ì—´ë¦¬ëŠ” ê³µì—° ì¼ì •ì„ ì•Œë ¤ì¤˜" data-text-en="Show me upcoming performances at the National Gugak Center">ğŸ¼ êµ­ì•… ê³µì—°</button>
        </div>
        <div class="composer-row">
          <div id="moreWrap" class="relative">
            <button id="moreBtn" class="icon-button" aria-label="ì¶”ê°€ ì˜µì…˜">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
            </button>
            <div id="fabDial" class="fab-dial" aria-label="ë¹ ë¥¸ ì‘ì—… ë©”ë‰´">
              <button class="mini-fab" data-action="voice" title="ìŒì„± ì…ë ¥" aria-label="ìŒì„± ì…ë ¥">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a3 3 0 00-3 3v5a3 3 0 106 0V6a3 3 0 00-3-3z"/><path d="M19 10a7 7 0 01-14 0"/><path d="M12 19v3"/></svg>
                <span class="fab-label" data-i18n="fab.voice">ìŒì„±</span>
              </button>
              <button class="mini-fab" data-action="attach-file" title="íŒŒì¼ ì²¨ë¶€" aria-label="íŒŒì¼ ì²¨ë¶€">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-8.49 8.49a5 5 0 01-7.07-7.07l8.49-8.49a3 3 0 114.24 4.24l-8.49 8.49a1 1 0 11-1.41-1.41l8.49-8.49"/></svg>
                <span class="fab-label" data-i18n="fab.file">íŒŒì¼</span>
              </button>
              <button class="mini-fab" data-action="attach-photo" title="ì‚¬ì§„ ì²¨ë¶€" aria-label="ì‚¬ì§„ ì²¨ë¶€">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16v10H4z"/><path d="M9 13l2-2 2 2 3-3 3 3"/></svg>
                <span class="fab-label" data-i18n="fab.photo">ì‚¬ì§„</span>
              </button>
              <button class="mini-fab" data-action="share-location" title="í˜„ì¬ ìœ„ì¹˜ ì¶”ê°€" aria-label="í˜„ì¬ ìœ„ì¹˜ ì¶”ê°€">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="10" r="3"/><path d="M12 2v2m0 12v6m10-10h-2M4 12H2m14.24 5.76l-1.42-1.42M7.17 5.17L5.76 3.76"/></svg>
                <span class="fab-label" data-i18n="fab.location">ìœ„ì¹˜</span>
              </button>
            </div>
          </div>

          <div class="field">
            <input id="input" class="input" placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”..." maxlength="500" data-i18n-placeholder="composer.placeholder" />
          </div>
          <button id="send" class="send" data-compact="true" aria-label="ë©”ì‹œì§€ ì „ì†¡">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3.4 20.4l17.4-8.4c.5-.2.5-.9 0-1.2L3.4 2.4c-.5-.2-1 .2-1 .7v5.5c0 .3.2.6.5.6l8.6.9c.2 0 .2.2 0 .3l-8.6.9c-.3 0-.5.3-.5.6V19.7c0 .5.4 1 1 .7z"/></svg>
            <span class="label" data-i18n="composer.send">ì „ì†¡</span>
          </button>
        </div>
      </div>
    </main>

    <section class="feed view" id="feedView">
      <div class="feed-inner">
        <div class="feed-intro">
          <span class="service-pill" data-i18n="feed.badge">ë§ì¶¤ í”¼ë“œ</span>
          <h2 data-i18n="feed.heading">ì „êµ­ ë¬¸í™”Â·ì˜ˆìˆ  í–‰ì‚¬ í”¼ë“œ</h2>
          <p data-i18n="feed.description">êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€, êµ­ë¦½ì¤‘ì•™ë„ì„œê´€, êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€ ë“± ì£¼ìš” ê¸°ê´€ì—ì„œ ìˆ˜ì§‘í•œ í–‰ì‚¬ ì •ë³´ë¥¼ í•œëˆˆì— ì‚´í´ë³´ì„¸ìš”.</p>
        </div>

        <div class="feed-controls">
          <div>
            <strong data-i18n="filter.institutions">í•µì‹¬ ê¸°ê´€</strong>
            <div class="filter-row" id="hostFilters">
              <button class="filter-chip active" data-host="all" data-i18n="filter.host.all">ì „ì²´</button>
              <button class="filter-chip" data-host="nmk" data-i18n="filter.host.nmk">êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€</button>
              <button class="filter-chip" data-host="nlib" data-i18n="filter.host.nlib">êµ­ë¦½ì¤‘ì•™ë„ì„œê´€</button>
              <button class="filter-chip" data-host="mmca" data-i18n="filter.host.mmca">êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€</button>
              <button class="filter-chip" data-host="gugak" data-i18n="filter.host.gugak">êµ­ë¦½êµ­ì•…ì›</button>
              <button class="filter-chip" data-host="folk" data-i18n="filter.host.folk">êµ­ë¦½ë¯¼ì†ë°•ë¬¼ê´€</button>
              <button class="filter-chip" data-host="others" data-i18n="filter.host.others">ê¸°íƒ€ êµ­ë¦½ê¸°ê´€</button>
            </div>
          </div>
          <div>
            <strong data-i18n="filter.status">ì§„í–‰ ìƒíƒœ</strong>
            <div class="filter-row" id="stateFilters">
              <button class="filter-chip active" data-state="all" data-i18n="filter.state.all">ì „ì²´</button>
              <button class="filter-chip" data-state="open" data-i18n="filter.state.open">ì§„í–‰ì¤‘</button>
              <button class="filter-chip" data-state="upcoming" data-i18n="filter.state.upcoming">ì˜ˆì •</button>
              <button class="filter-chip" data-state="closed" data-i18n="filter.state.closed">ë§ˆê°</button>
            </div>
          </div>
        </div>

        <div class="feed-insights">
          <h3 data-i18n="insight.title">AI ì¶”ì²œ ì¸ì‚¬ì´íŠ¸</h3>
          <div class="insight-list" id="insightList">
            <span data-i18n="insight.loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>
          </div>
        </div>

        <div id="feedStatus" class="empty-feed hidden"></div>
        <div class="feed-list" id="feedList"></div>
      </div>
    </section>
  </div>

  <script type="module">
    import { argbFromHex, themeFromSourceColor, applyTheme } from "https://esm.run/@material/material-color-utilities";

    const THEME_KEY = 'kaief_theme';
    const SEED_KEY = 'kaief_seed';
    const LOCALE_KEY = 'kaief_locale';

    const TRANSLATIONS = {
      ko: {
        'meta.title': 'KAIEF â€“ ëŒ€í•œë¯¼êµ­ í–‰ì‚¬ AI íŒŒì¸ë”',
        'brand.large': 'ëŒ€í•œë¯¼êµ­ í–‰ì‚¬ AI íŒŒì¸ë”',
        'brand.small': 'KAIEF',
        'lang.ko': 'í•œêµ­ì–´',
        'lang.en': 'English',
        'hero.paragraph': 'ë¬¸í™”ì²´ìœ¡ê´€ê´‘ë¶€ ì‚°í•˜ êµ­ë¦½ê¸°ê´€ í–‰ì‚¬ ì •ë³´ë¥¼ AIë¡œ íë ˆì´ì…˜í•˜ê³ , ê´€ì‹¬ì‚¬ ê¸°ë°˜ ë§ì¶¤ ì¶”ì²œì„ ì œê³µí•©ë‹ˆë‹¤.',
        'hero.pill1': 'LLM + RAG íë ˆì´ì…˜',
        'hero.pill2': 'í•œêµ­ì–´ Â· English ì„œë¹„ìŠ¤',
        'hero.pill3': 'ì‹œë‹ˆì–´ ìŒì„± ì§ˆì˜',
        'hero.pill4': 'PWA & ì‹¤ì‹œê°„ í¬ë¡¤ë§',
        'tab.chat': 'AI ì±—ë´‡',
        'tab.feed': 'í–‰ì‚¬ í”¼ë“œ',
        'assistant.badge': 'AI ì–´ì‹œìŠ¤í„´íŠ¸',
        'assistant.intro': 'ì•ˆë…•í•˜ì„¸ìš”! ğŸ‰<br/>ëŒ€í•œë¯¼êµ­ êµ­ë¦½ê¸°ê´€ì˜ ë¬¸í™”Â·ì˜ˆìˆ  í–‰ì‚¬ë¥¼ ì°¾ì•„ë“œë¦¬ëŠ” KAIEFì…ë‹ˆë‹¤. ì‹œê°„, ê´€ì‹¬ì‚¬, ì´ë™ ìˆ˜ë‹¨ì„ ì•Œë ¤ì£¼ì‹œë©´ ë§ì¶¤ ì¶”ì²œì„ ë“œë¦´ê²Œìš”.',
        'chip.weekend': 'ğŸª ì´ë²ˆ ì£¼ë§ ì¶”ì²œ',
        'chip.family': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡± ë§ì¶¤',
        'chip.free': 'ğŸ’¸ ë¬´ë£Œ ì „ì‹œ',
        'chip.global': 'ğŸŒ ì˜ì–´ ì•ˆë‚´ í–‰ì‚¬',
        'chip.gugak': 'ğŸ¼ êµ­ì•… ê³µì—°',
        'composer.placeholder': 'ì‹œê°„Â·ê´€ì‹¬ì‚¬ë¥¼ ë§ì”€í•´ ì£¼ì„¸ìš”...',
        'composer.send': 'ì „ì†¡',
        'fab.voice': 'ìŒì„±',
        'fab.file': 'íŒŒì¼',
        'fab.photo': 'ì‚¬ì§„',
        'fab.location': 'ìœ„ì¹˜',
        'chat.keywords': 'ğŸ” ì¶”ì¶œëœ í‚¤ì›Œë“œ',
        'chat.reason': 'ì¶”ì²œ ì´ìœ ',
        'chat.error': 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
        'chat.typing': 'ì…ë ¥ ì¤‘...',
        'voice.ready': 'ìŒì„± ì¸ì‹ì´ ì¤€ë¹„ë˜ì—ˆì–´ìš”. ì²œì²œíˆ ë§ì”€í•´ ì£¼ì„¸ìš”!',
        'voice.unsupported': 'ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
        'voice.result': 'ğŸ™ï¸ ìŒì„± ì…ë ¥: {text}',
        'voice.error': 'ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.',
        'feature.coming': 'í•´ë‹¹ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ê³§ ë§Œë‚˜ë³´ì„¸ìš”!',
        'feed.badge': 'ë§ì¶¤ í”¼ë“œ',
        'feed.heading': 'ì „êµ­ ë¬¸í™”Â·ì˜ˆìˆ  í–‰ì‚¬ í”¼ë“œ',
        'feed.description': 'êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€, êµ­ë¦½ì¤‘ì•™ë„ì„œê´€, êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€ ë“± ì£¼ìš” ê¸°ê´€ì—ì„œ ìˆ˜ì§‘í•œ ì‹¤ì‹œê°„ í–‰ì‚¬ì…ë‹ˆë‹¤.',
        'filter.institutions': 'í•µì‹¬ ê¸°ê´€',
        'filter.status': 'ì§„í–‰ ìƒíƒœ',
        'filter.host.all': 'ì „ì²´',
        'filter.host.nmk': 'êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€',
        'filter.host.nlib': 'êµ­ë¦½ì¤‘ì•™ë„ì„œê´€',
        'filter.host.mmca': 'êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€',
        'filter.host.gugak': 'êµ­ë¦½êµ­ì•…ì›',
        'filter.host.folk': 'êµ­ë¦½ë¯¼ì†ë°•ë¬¼ê´€',
        'filter.host.others': 'ê¸°íƒ€ êµ­ë¦½ê¸°ê´€',
        'filter.state.all': 'ì „ì²´',
        'filter.state.open': 'ì§„í–‰ì¤‘',
        'filter.state.upcoming': 'ì˜ˆì •',
        'filter.state.closed': 'ë§ˆê°',
        'insight.title': 'AI ì¶”ì²œ ì¸ì‚¬ì´íŠ¸',
        'insight.loading': 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...',
        'insight.total': 'ì¡°ê±´ì— ë§ëŠ” ë¬¸í™”Â·ì˜ˆìˆ  í–‰ì‚¬ {count}ê±´',
        'insight.top': 'ê°€ì¥ í™œë°œí•œ ê¸°ê´€: {host} ({count}ê±´)',
        'insight.updated': 'ë°ì´í„° ê°±ì‹ : {time}',
        'insight.realtime': 'LLM+RAG ê¸°ë°˜ìœ¼ë¡œ 30ë¶„ë§ˆë‹¤ ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤.',
        'feed.status.loading': 'í–‰ì‚¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...',
        'feed.status.empty': 'ì¡°ê±´ì— ë§ëŠ” í–‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ì¡°ì •í•´ ë³´ì„¸ìš”.',
        'feed.status.error': 'í–‰ì‚¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.',
        'card.untitled': 'ì œëª© ë¯¸ìƒ',
        'card.category': 'ë¶„ë¥˜',
        'card.categoryFallback': 'ì •ë³´ ì—†ìŒ',
        'card.schedule': 'ì¼ì •',
        'card.scheduleFallback': 'ì •ë³´ ì—†ìŒ',
        'card.location': 'ì¥ì†Œ',
        'card.locationFallback': 'ì •ë³´ ì—†ìŒ',
        'card.host': 'ì£¼ê´€',
        'card.hostFallback': 'ì •ë³´ ì—†ìŒ',
        'card.status': 'ìƒíƒœ',
        'card.link': 'ìì„¸íˆ ë³´ê¸°',
        'state.open': 'ì§„í–‰ì¤‘',
        'state.upcoming': 'ì˜ˆì •',
        'state.closed': 'ë§ˆê°',
        'state.unknown': 'ì •ë³´ ì—†ìŒ'
      },
      en: {
        'meta.title': 'KAIEF â€“ Korea Event AI Finder',
        'brand.large': 'Korea Event AI Finder',
        'brand.small': 'KAIEF',
        'lang.ko': 'í•œêµ­ì–´',
        'lang.en': 'English',
        'hero.paragraph': 'We fuse LLM + RAG to curate national cultural events and deliver precise, personalized recommendations.',
        'hero.pill1': 'LLM + RAG Curation',
        'hero.pill2': 'Korean Â· English service',
        'hero.pill3': 'Voice support for seniors',
        'hero.pill4': 'PWA & live crawling',
        'tab.chat': 'AI Chatbot',
        'tab.feed': 'Event Feed',
        'assistant.badge': 'AI Assistant',
        'assistant.intro': 'Hello! ğŸ‰<br/>KAIEF connects you to cultural & arts programs from Koreaâ€™s national institutions. Share your time, interests, or travel plans and I will tailor recommendations.',
        'chip.weekend': 'ğŸª Weekend picks',
        'chip.family': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family mode',
        'chip.free': 'ğŸ’¸ Free exhibitions',
        'chip.global': 'ğŸŒ English-friendly',
        'chip.gugak': 'ğŸ¼ Gugak performances',
        'composer.placeholder': 'Tell me your available time or interests...',
        'composer.send': 'Send',
        'fab.voice': 'Voice',
        'fab.file': 'File',
        'fab.photo': 'Photo',
        'fab.location': 'Location',
        'chat.keywords': 'ğŸ” Extracted keywords',
        'chat.reason': 'Why we recommend',
        'chat.error': 'Something went wrong. Please try again in a moment.',
        'chat.typing': 'Typing...',
        'voice.ready': 'Voice recognition is ready. Please speak clearly!',
        'voice.unsupported': 'Voice recognition is not supported in this browser.',
        'voice.result': 'ğŸ™ï¸ Voice input: {text}',
        'voice.error': 'We could not capture your voice input.',
        'feature.coming': 'This feature is coming soon. Stay tuned!',
        'feed.badge': 'Curated feed',
        'feed.heading': 'Nationwide Culture & Arts Feed',
        'feed.description': 'Live events sourced from national institutions including the National Museum of Korea, National Library of Korea, and MMCA.',
        'filter.institutions': 'Key institutions',
        'filter.status': 'Status',
        'filter.host.all': 'All',
        'filter.host.nmk': 'National Museum of Korea',
        'filter.host.nlib': 'National Library of Korea',
        'filter.host.mmca': 'MMCA',
        'filter.host.gugak': 'National Gugak Center',
        'filter.host.folk': 'National Folk Museum',
        'filter.host.others': 'Other national orgs',
        'filter.state.all': 'All',
        'filter.state.open': 'Ongoing',
        'filter.state.upcoming': 'Upcoming',
        'filter.state.closed': 'Closed',
        'insight.title': 'AI Insights',
        'insight.loading': 'Loading event data...',
        'insight.total': '{count} events match your filters',
        'insight.top': 'Most active institution: {host} ({count})',
        'insight.updated': 'Last updated: {time}',
        'insight.realtime': 'Synced every 30 minutes via LLM + RAG pipeline.',
        'feed.status.loading': 'Loading event data...',
        'feed.status.empty': 'No events found. Try adjusting the filters.',
        'feed.status.error': 'We were unable to load events.',
        'card.untitled': 'Untitled event',
        'card.category': 'Category',
        'card.categoryFallback': 'N/A',
        'card.schedule': 'Schedule',
        'card.scheduleFallback': 'N/A',
        'card.location': 'Venue',
        'card.locationFallback': 'N/A',
        'card.host': 'Host',
        'card.hostFallback': 'N/A',
        'card.status': 'Status',
        'card.link': 'View details',
        'state.open': 'Ongoing',
        'state.upcoming': 'Upcoming',
        'state.closed': 'Closed',
        'state.unknown': 'N/A'
      }
    };

    const HOST_LABELS = {
      'êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€': { en: 'National Museum of Korea' },
      'êµ­ë¦½ì¤‘ì•™ë„ì„œê´€': { en: 'National Library of Korea' },
      'êµ­ë¦½ì–´ë¦°ì´ì²­ì†Œë…„ë„ì„œê´€': { en: 'National Library for Children and Young Adults' },
      'êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€': { en: 'National Museum of Modern and Contemporary Art' },
      'êµ­ë¦½êµ­ì•…ì›': { en: 'National Gugak Center' },
      'êµ­ë¦½ë¯¼ì†ë°•ë¬¼ê´€': { en: 'National Folk Museum of Korea' },
      'êµ­ë¦½ì¶˜ì²œë°•ë¬¼ê´€': { en: 'National Chuncheon Museum' },
      'êµ­ë¦½ì œì£¼ë°•ë¬¼ê´€': { en: 'National Jeju Museum' }
    };

    const CORE_HOSTS = {
      nmk: ['êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€'],
      nlib: ['êµ­ë¦½ì¤‘ì•™ë„ì„œê´€', 'êµ­ë¦½ì–´ë¦°ì´ì²­ì†Œë…„ë„ì„œê´€'],
      mmca: ['êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€'],
      gugak: ['êµ­ë¦½êµ­ì•…ì›'],
      folk: ['êµ­ë¦½ë¯¼ì†ë°•ë¬¼ê´€']
    };

    const root = document.documentElement;
    const appBar = document.getElementById('appBar');
    const themeToggle = document.getElementById('themeToggle');
    const sun = document.getElementById('sun');
    const moon = document.getElementById('moon');
    const paletteBtn = document.getElementById('paletteBtn');
    const brandPanel = document.getElementById('brandPanel');
    const customSeed = document.getElementById('customSeed');
    const customSeedHex = document.getElementById('customSeedHex');
    const applySeed = document.getElementById('applySeed');
    const chatView = document.getElementById('chatView');
    const feedView = document.getElementById('feedView');
    const chatList = document.getElementById('chatList');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const sendLabel = send.querySelector('.label');
    const chips = document.getElementById('chips');
    const fabDial = document.getElementById('fabDial');
    const moreBtn = document.getElementById('moreBtn');
    const moreWrap = document.getElementById('moreWrap');
    const languageButtons = document.querySelectorAll('[data-locale]');
    const viewButtons = document.querySelectorAll('[data-view]');
    const hostFilters = document.getElementById('hostFilters');
    const stateFilters = document.getElementById('stateFilters');
    const feedList = document.getElementById('feedList');
    const feedStatus = document.getElementById('feedStatus');
    const insightList = document.getElementById('insightList');

    let currentSeed = localStorage.getItem(SEED_KEY) || '#6366F1';
    let currentLocale = localStorage.getItem(LOCALE_KEY) || 'ko';
    let feedLoaded = false;
    let eventsData = [];
    let eventsUpdatedAt = null;
    let activeHost = 'all';
    let activeState = 'all';
    let typingEl = null;
    let dialOpen = false;
    let feedStatusType = 'none';
    let feedStatusExtra = '';

    function getDict(){
      return TRANSLATIONS[currentLocale] || TRANSLATIONS.ko;
    }

    function formatString(template, values = {}){
      return template.replace(/\{(.*?)\}/g, (_, key) => values[key] ?? '');
    }

    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]));
    }

    function localizeHost(name){
      if (!name) return '';
      const entry = HOST_LABELS[name];
      if (currentLocale === 'en' && entry && entry.en){
        return `${entry.en} (${name})`;
      }
      return name;
    }

    function formatUpdatedAt(value){
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      const locale = currentLocale === 'en' ? 'en-US' : 'ko-KR';
      return new Intl.DateTimeFormat(locale, { dateStyle: 'medium', timeStyle: 'short' }).format(date);
    }

    function isDark(){
      return root.getAttribute('data-theme') === 'dark';
    }

    function applyThemeFromSeed(hex){
      try {
        const theme = themeFromSourceColor(argbFromHex(hex));
        applyTheme(theme, { target: root, dark: isDark() });
        document.documentElement.style.setProperty('--gradient-primary', `linear-gradient(135deg, var(--md-sys-color-primary) 0%, color-mix(in oklab, var(--md-sys-color-primary) 85%, #ffffff) 50%, color-mix(in oklab, var(--md-sys-color-primary) 70%, #ffffff) 100%)`);
        currentSeed = hex;
        localStorage.setItem(SEED_KEY, hex);
      } catch (error) {
        console.warn('Dynamic color apply failed', error);
      }
    }

    function applyThemeMode(mode){
      root.setAttribute('data-theme', mode);
      localStorage.setItem(THEME_KEY, mode);
      const dark = mode === 'dark';
      sun.style.display = dark ? 'none' : 'block';
      moon.style.display = dark ? 'block' : 'none';
      applyThemeFromSeed(currentSeed);
    }

    function translateDocument(){
      const dict = getDict();
      document.title = dict['meta.title'];
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (key && dict[key] !== undefined){
          el.innerHTML = dict[key];
        }
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (key && dict[key] !== undefined){
          el.setAttribute('placeholder', dict[key]);
        }
      });
      languageButtons.forEach(button => {
        button.classList.toggle('active', button.dataset.locale === currentLocale);
      });
      chips.querySelectorAll('.chip').forEach(button => {
        const key = currentLocale === 'en' ? 'textEn' : 'textKo';
        if (button.dataset[key]){
          button.dataset.text = button.dataset[key];
        }
      });
      if (feedStatusType !== 'none'){
        setFeedStatus(feedStatusType, feedStatusExtra);
      }
    }

    function applyLocale(locale){
      if (!TRANSLATIONS[locale]) locale = 'ko';
      currentLocale = locale;
      localStorage.setItem(LOCALE_KEY, locale);
      document.documentElement.lang = locale === 'en' ? 'en' : 'ko';
      translateDocument();
      updateSend();
      if (feedLoaded) renderFeed();
    }

    function setFeedStatus(type, extra = ''){
      const dict = getDict();
      feedStatusType = type;
      feedStatusExtra = extra;
      if (type === 'none'){
        feedStatus.classList.add('hidden');
        feedStatus.textContent = '';
        return;
      }
      feedStatus.classList.remove('hidden');
      let message = dict[`feed.status.${type}`] || '';
      if (type === 'error' && extra){
        message += ` (${extra})`;
      }
      feedStatus.textContent = message;
    }

    function normalizeState(value){
      if (!value) return 'unknown';
      const text = String(value).toLowerCase();
      if (['ì§„í–‰', 'ìƒì‹œ', 'ìš´ì˜', 'ongoing', 'run'].some(token => text.includes(token))) return 'open';
      if (['ì˜ˆì •', 'ëª¨ì§‘', 'ì ‘ìˆ˜', 'upcoming', 'open soon'].some(token => text.includes(token))) return 'upcoming';
      if (['ë§ˆê°', 'ì¢…ë£Œ', 'ì™„ë£Œ', 'closed', 'end'].some(token => text.includes(token))) return 'closed';
      return 'unknown';
    }

    function matchesHost(event){
      const host = event.host || '';
      if (activeHost === 'all') return true;
      if (activeHost === 'others'){
        return !Object.values(CORE_HOSTS).some(names => names.some(name => host.includes(name)));
      }
      const names = CORE_HOSTS[activeHost];
      if (names){
        return names.some(name => host.includes(name));
      }
      return host.includes(activeHost);
    }

    function matchesState(event){
      if (activeState === 'all') return true;
      return normalizeState(event.state) === activeState;
    }

    function updateSend(){
      const dict = getDict();
      const hasText = input.value.trim().length > 0;
      send.setAttribute('data-compact', hasText ? 'false' : 'true');
      sendLabel.textContent = dict['composer.send'];
      if (hasText){
        sendLabel.removeAttribute('aria-hidden');
      } else {
        sendLabel.setAttribute('aria-hidden', 'true');
      }
    }

    function addBubble(role, html){
      const row = document.createElement('div');
      row.className = 'flex ' + (role === 'user' ? 'justify-end' : 'justify-start');
      row.innerHTML = `<div class="bubble ${role}">${html}</div>`;
      chatList.appendChild(row);
      chatList.scrollTo({ top: chatList.scrollHeight, behavior: 'smooth' });
    }

    function showTyping(){
      const dict = getDict();
      const row = document.createElement('div');
      row.className = 'flex justify-start';
      row.innerHTML = `
        <div class="bubble assistant">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-5 h-5 rounded-full" style="background:linear-gradient(90deg,#34D399,#06B6D4)"></div>
            <span class="text-xs opacity-70">${escapeHTML(dict['chat.typing'])}</span>
          </div>
          <div class="dots"><span></span><span></span><span></span></div>
        </div>`;
      chatList.appendChild(row);
      typingEl = row;
      chatList.scrollTo({ top: chatList.scrollHeight, behavior: 'smooth' });
    }

    function hideTyping(){
      if (typingEl) typingEl.remove();
      typingEl = null;
    }

    function renderKeywords(keywords = []){
      if (!keywords || keywords.length === 0) return '';
      const pills = keywords.slice(0, 8).map(keyword => `<span class="px-2 py-1 rounded-full border border-[var(--md-sys-color-outline-variant)] bg-[var(--md-sys-color-surface-container)] text-xs">${escapeHTML(keyword)}</span>`).join(' ');
      return `<div class="mt-2 flex flex-wrap gap-1 items-center">${pills}</div>`;
    }

    function renderEventCard(event){
      const dict = getDict();
      if (!event || Object.keys(event).length === 0){
        return `<div class="text-sm opacity-80">${escapeHTML(dict['feed.status.empty'])}</div>`;
      }
      const title = escapeHTML(event.title || dict['card.untitled']);
      const host = escapeHTML(localizeHost(event.host || dict['card.hostFallback']));
      const category = escapeHTML(event.category || dict['card.categoryFallback']);
      const schedule = escapeHTML(event.date || event.datetime || event.period || dict['card.scheduleFallback']);
      const location = escapeHTML(event.location || event.place || dict['card.locationFallback']);
      const description = escapeHTML(event.deep_data || event.description || '');
      const url = event.url ? escapeHTML(event.url) : '';
      return `
        <div class="mt-2 p-3 rounded-[16px] border border-[var(--md-sys-color-outline-variant)] bg-[var(--md-sys-color-surface-container-low)] shadow-sm">
          <div class="text-base font-semibold mb-1" style="letter-spacing:-0.01em">${title}</div>
          <div class="flex flex-wrap gap-x-3 gap-y-1 text-sm opacity-80">
            <div>ğŸ›ï¸ ${dict['card.host']} Â· ${host}</div>
            <div>ğŸ“‚ ${dict['card.category']} Â· ${category}</div>
            <div>ğŸ“… ${dict['card.schedule']} Â· ${schedule}</div>
            <div>ğŸ“ ${dict['card.location']} Â· ${location}</div>
          </div>
          ${description ? `<div class="mt-2 text-sm leading-6">${description}</div>` : ''}
          ${url ? `<a class="mt-2 inline-flex text-sm font-semibold text-[var(--md-sys-color-primary)]" href="${url}" target="_blank" rel="noopener noreferrer">${dict['card.link']}</a>` : ''}
        </div>`;
    }

    async function sendMessage(){
      const dict = getDict();
      const text = input.value.trim();
      if (!text) return;

      addBubble('user', escapeHTML(text));
      input.value = '';
      updateSend();
      showTyping();

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        const data = await response.json();
        hideTyping();
        const payload = data.response || {};
        const keywords = payload.keywords || [];
        const event = payload.recommended_event || {};
        const reason = payload.reason;

        let html = '';
        if (keywords.length){
          html += `<div class="text-sm opacity-70 mb-1">${escapeHTML(dict['chat.keywords'])}</div>${renderKeywords(keywords)}`;
        }
        if (reason){
          html += `<div class="mt-3 text-sm opacity-80">${escapeHTML(dict['chat.reason'])}</div><div class="mt-1">${escapeHTML(reason)}</div>`;
        }
        html += renderEventCard(event);
        addBubble('assistant', html);
      } catch (error){
        hideTyping();
        addBubble('assistant', `<div class="text-sm">${escapeHTML(dict['chat.error'])}</div><div class="mt-2 text-xs opacity-70">${escapeHTML(String(error))}</div>`);
      }
    }

    function createFeedCard(event){
      const dict = getDict();
      const card = document.createElement('article');
      card.className = 'feed-card';
      const title = escapeHTML(event.title || dict['card.untitled']);
      const host = escapeHTML(localizeHost(event.host || dict['card.hostFallback']));
      const schedule = escapeHTML(event.period || event.date || event.datetime || dict['card.scheduleFallback']);
      const location = escapeHTML(event.place || event.location || dict['card.locationFallback']);
      const statusKey = normalizeState(event.state);
      const statusLabel = dict[`state.${statusKey}`] || dict['state.unknown'];
      const description = escapeHTML(event.description || event.deep_data || '');
      card.innerHTML = `
        <h3>${title}</h3>
        <div class="meta">
          <span>ğŸ›ï¸ ${dict['card.host']} Â· ${host}</span>
          <span>ğŸ“… ${dict['card.schedule']} Â· ${schedule}</span>
          <span>ğŸ“ ${dict['card.location']} Â· ${location}</span>
          <span>ğŸ”– ${dict['card.status']} Â· ${statusLabel}</span>
        </div>
        ${description ? `<p class="text-sm leading-6">${description}</p>` : ''}
      `;
      if (event.url){
        const link = document.createElement('a');
        link.href = event.url;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = dict['card.link'];
        card.appendChild(link);
      }
      return card;
    }

    function renderInsights(events){
      const dict = getDict();
      insightList.innerHTML = '';
      const total = document.createElement('div');
      total.textContent = formatString(dict['insight.total'], { count: events.length });
      insightList.appendChild(total);

      if (events.length){
        const hostCounts = new Map();
        events.forEach(event => {
          const name = event.host || dict['card.hostFallback'];
          hostCounts.set(name, (hostCounts.get(name) || 0) + 1);
        });
        let topHost = '';
        let topCount = 0;
        for (const [name, count] of hostCounts.entries()){
          if (count > topCount){
            topHost = name;
            topCount = count;
          }
        }
        const hostLine = document.createElement('div');
        hostLine.textContent = formatString(dict['insight.top'], { host: localizeHost(topHost), count: topCount });
        insightList.appendChild(hostLine);
      }

      const updated = formatUpdatedAt(eventsUpdatedAt);
      if (updated){
        const updatedLine = document.createElement('div');
        updatedLine.textContent = formatString(dict['insight.updated'], { time: updated });
        insightList.appendChild(updatedLine);
      }

      const realtime = document.createElement('div');
      realtime.textContent = dict['insight.realtime'];
      insightList.appendChild(realtime);
    }

    function renderFeed(){
      if (!feedLoaded) return;
      const filtered = eventsData.filter(event => matchesHost(event) && matchesState(event));
      feedList.innerHTML = '';
      if (!filtered.length){
        setFeedStatus('empty');
      } else {
        setFeedStatus('none');
        filtered.forEach(event => feedList.appendChild(createFeedCard(event)));
      }
      renderInsights(filtered);
    }

    async function ensureFeedLoaded(){
      if (feedLoaded){
        renderFeed();
        return;
      }
      setFeedStatus('loading');
      try {
        const response = await fetch('/events');
        if (!response.ok) throw new Error(response.statusText);
        const data = await response.json();
        eventsData = Array.isArray(data.events) ? data.events : [];
        eventsUpdatedAt = data.updatedAt || null;
        feedLoaded = true;
        renderFeed();
      } catch (error){
        console.error('Failed to load events', error);
        setFeedStatus('error', error.message);
      }
    }

    function handleFabAction(action){
      const dict = getDict();
      if (action === 'voice'){
        startVoiceCapture();
        return;
      }
      addBubble('assistant', `<div class="text-sm">${escapeHTML(dict['feature.coming'])}</div>`);
    }

    function startVoiceCapture(){
      const dict = getDict();
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition){
        addBubble('assistant', `<div class="text-sm">${escapeHTML(dict['voice.unsupported'])}</div>`);
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = currentLocale === 'en' ? 'en-US' : 'ko-KR';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onstart = () => {
        addBubble('assistant', `<div class="text-sm">${escapeHTML(dict['voice.ready'])}</div>`);
      };
      recognition.onerror = () => {
        addBubble('assistant', `<div class="text-sm">${escapeHTML(dict['voice.error'])}</div>`);
      };
      recognition.onresult = event => {
        const transcript = event.results?.[0]?.[0]?.transcript?.trim();
        if (!transcript) return;
        addBubble('assistant', `<div class="text-sm">${escapeHTML(formatString(dict['voice.result'], { text: transcript }))}</div>`);
        input.value = transcript;
        updateSend();
        sendMessage();
      };
      recognition.start();
    }

    function setActiveView(view){
      viewButtons.forEach(button => button.classList.toggle('active', button.dataset.view === view));
      if (view === 'feed'){
        chatView.classList.remove('active');
        feedView.classList.add('active');
        ensureFeedLoaded();
      } else {
        feedView.classList.remove('active');
        chatView.classList.add('active');
      }
    }

    chatList.addEventListener('scroll', () => {
      if (chatList.scrollTop > 6) appBar.classList.add('compact');
      else appBar.classList.remove('compact');
    });

    themeToggle.addEventListener('click', () => {
      applyThemeMode(isDark() ? 'light' : 'dark');
    });

    paletteBtn.addEventListener('click', event => {
      event.stopPropagation();
      brandPanel.classList.toggle('open');
    });

    document.addEventListener('click', event => {
      if (!brandPanel.contains(event.target) && event.target !== paletteBtn){
        brandPanel.classList.remove('open');
      }
      if (dialOpen && !moreWrap.contains(event.target)){
        dialOpen = false;
        fabDial.classList.remove('open');
      }
    });

    brandPanel.addEventListener('click', event => {
      const target = event.target.closest('.chip');
      if (!target || !target.dataset.seed) return;
      customSeed.value = target.dataset.seed;
      customSeedHex.value = target.dataset.seed;
      applyThemeFromSeed(target.dataset.seed);
    });

    customSeed.addEventListener('input', () => {
      customSeedHex.value = customSeed.value;
    });

    customSeedHex.addEventListener('input', () => {
      if (/^#([0-9a-fA-F]{6})$/.test(customSeedHex.value)){
        customSeed.value = customSeedHex.value;
      }
    });

    applySeed.addEventListener('click', () => {
      if (/^#([0-9a-fA-F]{6})$/.test(customSeed.value)){
        applyThemeFromSeed(customSeed.value);
      }
    });

    input.addEventListener('input', updateSend);
    input.addEventListener('keydown', event => {
      if (event.key === 'Enter' && !event.shiftKey && !event.isComposing){
        event.preventDefault();
        sendMessage();
      }
    });
    send.addEventListener('click', sendMessage);

    chips.addEventListener('click', event => {
      const button = event.target.closest('.chip');
      if (!button) return;
      input.value = button.dataset.text || '';
      updateSend();
      input.focus();
    });

    moreBtn.addEventListener('click', event => {
      event.stopPropagation();
      dialOpen = !dialOpen;
      fabDial.classList.toggle('open', dialOpen);
    });

    fabDial.addEventListener('click', event => {
      const button = event.target.closest('.mini-fab');
      if (!button) return;
      handleFabAction(button.dataset.action);
      dialOpen = false;
      fabDial.classList.remove('open');
    });

    const resizeObserver = new ResizeObserver(() => {
      dialOpen = false;
      fabDial.classList.remove('open');
    });
    resizeObserver.observe(document.body);

    languageButtons.forEach(button => {
      button.addEventListener('click', () => applyLocale(button.dataset.locale));
    });

    viewButtons.forEach(button => {
      button.addEventListener('click', () => setActiveView(button.dataset.view));
    });

    hostFilters.addEventListener('click', event => {
      const button = event.target.closest('.filter-chip');
      if (!button) return;
      hostFilters.querySelectorAll('.filter-chip').forEach(node => node.classList.remove('active'));
      button.classList.add('active');
      activeHost = button.dataset.host || 'all';
      renderFeed();
    });

    stateFilters.addEventListener('click', event => {
      const button = event.target.closest('.filter-chip');
      if (!button) return;
      stateFilters.querySelectorAll('.filter-chip').forEach(node => node.classList.remove('active'));
      button.classList.add('active');
      activeState = button.dataset.state || 'all';
      renderFeed();
    });

    applyThemeMode(localStorage.getItem(THEME_KEY) || 'light');
    applyThemeFromSeed(currentSeed);
    applyLocale(currentLocale);
    updateSend();
    setActiveView('chat');
  </script>
</body>
</html>
