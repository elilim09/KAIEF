<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>KAIEF â€“ ëŒ€í•œë¯¼êµ­ í–‰ì‚¬ AI íŒŒì¸ë”</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Material 3 Expressive-friendly fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght,GRAD,slnt,YOPQ@8..144,300..900,-200..150,-12..0,25..135&family=Noto+Sans+KR:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --seed-primary:  #6366F1;
      --seed-secondary:#06B6D4;
      --seed-tertiary: #10B981;

      --md-sys-color-primary: var(--seed-primary);
      --md-sys-color-on-primary: #FFFFFF;
      --md-sys-color-primary-container: #E0E7FF;
      --md-sys-color-on-primary-container: #1E1B4B;

      --md-sys-color-secondary: #64748B;
      --md-sys-color-on-secondary: #FFFFFF;
      --md-sys-color-secondary-container: #E2F6FA;
      --md-sys-color-on-secondary-container: #07242B;

      --md-sys-color-tertiary:  var(--seed-tertiary);
      --md-sys-color-on-tertiary:#FFFFFF;
      --md-sys-color-tertiary-container:#D1FAE5;
      --md-sys-color-on-tertiary-container:#064E3B;

      --md-sys-color-error:#DC2626;
      --md-sys-color-on-error:#FFFFFF;
      --md-sys-color-error-container:#FEE2E2;
      --md-sys-color-on-error-container:#7F1D1D;

      --md-sys-color-surface: #FAFBFC;
      --md-sys-color-on-surface: #0F172A;
      --md-sys-color-surface-dim: #EFF2F6;
      --md-sys-color-surface-bright: #FFFFFF;
      --md-sys-color-surface-container-lowest: #FFFFFF;
      --md-sys-color-surface-container-low: #F8FAFC;
      --md-sys-color-surface-container: #F1F5F9;
      --md-sys-color-surface-container-high: #E2E8F0;
      --md-sys-color-surface-container-highest: #CBD5E1;

      --md-sys-color-outline: #CBD5E1;
      --md-sys-color-outline-variant: #E2E8F0;

      --shape-corner-xs: 4px;
      --shape-corner-sm: 8px;
      --shape-corner-md: 12px;
      --shape-corner-lg: 16px;
      --shape-corner-xl: 28px;
      --shape-corner-2xl: 48px;
      --shape-corner-full: 9999px;

      --easing-standard: cubic-bezier(0.2, 0, 0, 1);
      --easing-emphasized: cubic-bezier(0.05, 0.7, 0.1, 1);
      --easing-expressive: cubic-bezier(0.25, 0.8, 0.2, 1);
      --dur-quick: 140ms;
      --dur-standard: 220ms;
      --dur-long: 360ms;

      --elevation-1: 0 1px 2px rgba(0,0,0,0.06);
      --elevation-2: 0 4px 8px rgba(0,0,0,0.08);
      --elevation-3: 0 8px 16px rgba(0,0,0,0.10);
      --elevation-4: 0 16px 24px rgba(0,0,0,0.12);
      --elevation-5: 0 24px 40px rgba(0,0,0,0.16);

      --gradient-primary: linear-gradient(135deg, #6366F1 0%, #8B5CF6 50%, #A855F7 100%);
      --gradient-surface: linear-gradient(180deg, var(--md-sys-color-surface) 0%, var(--md-sys-color-surface-container-low) 100%);
    }

    [data-theme="dark"] {
      --md-sys-color-primary: #818CF8;
      --md-sys-color-on-primary: #1E1B4B;
      --md-sys-color-primary-container: #312E81;
      --md-sys-color-on-primary-container: #E0E7FF;

      --md-sys-color-secondary: #94A3B8;
      --md-sys-color-on-secondary: #0B1220;
      --md-sys-color-secondary-container: #101826;
      --md-sys-color-on-secondary-container: #E5EEF7;

      --md-sys-color-tertiary: #34D399;
      --md-sys-color-on-tertiary: #052016;
      --md-sys-color-tertiary-container: #0B3B2B;
      --md-sys-color-on-tertiary-container: #D1FAE5;

      --md-sys-color-surface: #0F172A;
      --md-sys-color-on-surface: #F1F5F9;
      --md-sys-color-surface-dim: #0B1426;
      --md-sys-color-surface-bright: #162036;
      --md-sys-color-surface-container-lowest: #0A1222;
      --md-sys-color-surface-container-low: #0E1729;
      --md-sys-color-surface-container: #1C2540;
      --md-sys-color-surface-container-high: #293351;
      --md-sys-color-surface-container-highest: #364166;

      --md-sys-color-outline: #334155;
      --md-sys-color-outline-variant: #1E293B;

      --gradient-surface: linear-gradient(180deg, #0F172A 0%, #1E293B 100%);
    }

    html, body { height: 100%; }
    body {
      font-family: 'Roboto Flex', 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      background: var(--gradient-surface);
      color: var(--md-sys-color-on-surface);
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
    }

    .app { width: min(430px, 100vw); min-height: 100dvh; margin: 0 auto; position: relative; display:flex; flex-direction:column; }

    .app-bar { position: sticky; top: 0; z-index: 30; background: var(--md-sys-color-surface); backdrop-filter: saturate(1.3) blur(10px); border-bottom: 1px solid var(--md-sys-color-outline-variant); transition: padding var(--dur-standard) var(--easing-emphasized), box-shadow var(--dur-standard) var(--easing-standard); padding: 18px 20px 12px; }
    .app-bar.compact { padding: 8px 16px; box-shadow: var(--elevation-1); }
    .brand { display:flex; align-items:center; gap:12px; }
    .brand-badge { width: 36px; height: 36px; border-radius: var(--shape-corner-xl); background: var(--gradient-primary); display:flex; align-items:center; justify-content:center; color:#fff; box-shadow: var(--elevation-2); }
    .brand-title { font-weight: 800; letter-spacing: -0.02em; }
    .brand-title .large { font-size: 20px; background: var(--gradient-primary); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .brand-title .small { font-size: 16px; opacity: .9; display:none; }
    .app-bar.compact .brand-title .large { display:none; }
    .app-bar.compact .brand-title .small { display:inline-block; }

    .app-controls { margin-top: 16px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    .tab-group { display:flex; gap:4px; padding:4px; border-radius: var(--shape-corner-full); background: var(--md-sys-color-surface-container-low); border:1px solid var(--md-sys-color-outline-variant); }
    .tab { border:0; background:transparent; border-radius: var(--shape-corner-full); padding:8px 16px; font-weight:600; font-size:14px; color: color-mix(in oklab, var(--md-sys-color-on-surface) 75%, transparent); cursor:pointer; transition: background var(--dur-quick) var(--easing-standard), color var(--dur-quick) var(--easing-standard); }
    .tab:hover { background: var(--md-sys-color-surface-container); color: var(--md-sys-color-on-surface); }
    .tab[aria-selected="true"], .tab.active { background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); box-shadow: var(--elevation-1); }
    .language-toggle { font-size:13px; font-weight:600; padding:8px 14px; }

    .icon-button { width: 40px; height: 40px; border-radius: var(--shape-corner-lg); display:grid; place-items:center; border:1px solid var(--md-sys-color-outline-variant); background: var(--md-sys-color-surface-container-low); color: var(--md-sys-color-on-surface); transition: transform var(--dur-quick) var(--easing-standard), background var(--dur-quick) var(--easing-standard); }
    .icon-button:hover { transform: translateY(-1px); background: var(--md-sys-color-surface-container); }
    .icon-button:active { transform: scale(.97); }
    .theme-toggle { background: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container); border-color: transparent; }

    .popover { position:absolute; right: 16px; top: 60px; width: 280px; padding: 12px; border-radius: var(--shape-corner-xl); background: var(--md-sys-color-surface-container); border:1px solid var(--md-sys-color-outline-variant); box-shadow: var(--elevation-4); transform-origin: top right; opacity:0; transform: scale(.96); pointer-events:none; transition: opacity var(--dur-standard) var(--easing-standard), transform var(--dur-standard) var(--easing-emphasized); }
    .popover.open { opacity:1; transform: scale(1); pointer-events:auto; }
    .chip { padding:8px 14px; border-radius: var(--shape-corner-full); font-size:13px; font-weight:500; cursor:pointer; border:1px solid var(--md-sys-color-outline-variant); background: var(--md-sys-color-surface-container-low); color: var(--md-sys-color-on-surface); transition: transform var(--dur-quick) var(--easing-standard), background var(--dur-quick) var(--easing-standard), border-color var(--dur-quick) var(--easing-standard); }
    .chip:hover{ transform: translateY(-1px); background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); border-color: var(--md-sys-color-primary); }
    .chip[data-active="true"]{ background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); border-color: var(--md-sys-color-primary); box-shadow: var(--elevation-2); }

    .view { display:none; flex:1; min-height:0; }
    .view.active { display:flex; }
    .chat { flex:1; min-height:0; display:flex; flex-direction:column; background: var(--md-sys-color-surface); }
    .chat-list { flex:1; min-height:0; padding: 14px 20px; overflow-y:auto; scroll-behavior:smooth; }
    .chat-list::-webkit-scrollbar{ width:6px; } .chat-list::-webkit-scrollbar-thumb{ background: var(--md-sys-color-outline); border-radius:3px; }

    .bubble{ max-width:82%; line-height:1.55; font-size:15px; padding:14px 16px; border-radius: var(--shape-corner-xl); position:relative; animation: slideUp var(--dur-standard) var(--easing-emphasized); }
    .bubble.assistant{ background: var(--md-sys-color-surface-container); color: var(--md-sys-color-on-surface); border:1px solid var(--md-sys-color-outline-variant); border-bottom-left-radius: var(--shape-corner-sm); }
    .assistant-header{ display:flex; align-items:center; gap:8px; margin-bottom:10px; }
    .bubble.user{ background: var(--gradient-primary); color: var(--md-sys-color-on-primary); margin-left:auto; box-shadow: var(--elevation-2); border-bottom-right-radius: var(--shape-corner-sm); }
    @keyframes slideUp { from { opacity:0; transform: translateY(16px) scale(.98); } to { opacity:1; transform: translateY(0) scale(1); } }

    .composer { padding: 10px 12px calc(14px + env(safe-area-inset-bottom)); border-top: 1px solid var(--md-sys-color-outline-variant); background: var(--md-sys-color-surface); position:relative; z-index: 10; }
    .composer-row { display:flex; gap:10px; align-items:flex-end; }

    .field { flex:1; display:flex; align-items:center; background: var(--md-sys-color-surface-container); border: 2px solid var(--md-sys-color-outline-variant); border-radius: var(--shape-corner-full); transition: border-color var(--dur-quick) var(--easing-standard), box-shadow var(--dur-quick) var(--easing-standard), background var(--dur-quick) var(--easing-standard); padding: 2px 6px; position:relative; }
    .field:focus-within{ border-color: var(--md-sys-color-primary); box-shadow: 0 0 0 4px color-mix(in oklab, var(--md-sys-color-primary) 20%, transparent); background: var(--md-sys-color-surface-container-high); }
    .input{ flex:1; border:0; outline:0; background: transparent; color: var(--md-sys-color-on-surface); font-size: 15px; padding: 10px 10px; }
    .input::placeholder{ color: color-mix(in oklab, var(--md-sys-color-on-surface) 55%, transparent); }

    .send { height:56px; min-width:56px; border-radius: var(--shape-corner-full); border:0; cursor:pointer; color:var(--md-sys-color-on-primary); background: var(--gradient-primary); display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:0 18px; box-shadow: var(--elevation-3); transition: width var(--dur-standard) var(--easing-emphasized), padding var(--dur-standard) var(--easing-emphasized), transform var(--dur-quick) var(--easing-standard), box-shadow var(--dur-quick) var(--easing-standard); }
    .send:hover{ box-shadow: var(--elevation-5); transform: translateY(-2px); }
    .send:active{ transform: translateY(0) scale(.985); transition-duration: 90ms; }
    .send[data-compact="true"]{ width:56px; padding:0; }
    .send .label{ white-space:nowrap; overflow:hidden; max-width:0; opacity:0; transition: max-width var(--dur-standard) var(--easing-emphasized), opacity var(--dur-standard) var(--easing-standard); }
    .send[data-compact="false"] .label{ max-width:120px; opacity:1; }
    .send svg { display: block; }
    .send[data-compact="true"] { gap: 0; }
    .send .label { line-height: 1; margin: 0; }

    /* ======= Reworked FAB Speed Dial (anchored to more button) ======= */
    .fab-dial { position:absolute; right: 0; bottom: 56px; display:flex; flex-direction:column; gap:10px; transform-origin: bottom right; pointer-events:none; }
    .fab-dial.open { pointer-events:auto; }
    .mini-fab { position:relative; width:48px; height:48px; border-radius: var(--shape-corner-full); display:grid; place-items:center; border:1px solid var(--md-sys-color-outline-variant); background: var(--md-sys-color-surface-container); color: var(--md-sys-color-on-surface); box-shadow: var(--elevation-3); transform: scale(.9) translateY(8px); opacity:0; transition: transform var(--dur-standard) var(--easing-emphasized), opacity var(--dur-standard) var(--easing-standard); }
    .fab-dial.open .mini-fab { transform: scale(1) translateY(0); opacity:1; }
    .mini-fab:nth-child(1){ transition-delay: 20ms; } .mini-fab:nth-child(2){ transition-delay: 60ms; } .mini-fab:nth-child(3){ transition-delay: 100ms; }
    .mini-fab:focus-visible{ outline: 3px solid color-mix(in oklab, var(--md-sys-color-primary) 45%, transparent); }
    .fab-label { position:absolute; right: 54px; top:50%; transform: translateY(-50%); padding:6px 10px; border-radius: var(--shape-corner-full); font-size:12px; background: var(--md-sys-color-surface-container-high); border:1px solid var(--md-sys-color-outline-variant); box-shadow: var(--elevation-2); opacity:0; pointer-events:none; transition: opacity var(--dur-quick) var(--easing-standard); }
    .mini-fab:hover .fab-label { opacity:1; }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; padding: 0 6px; }
    .chip-label{ font-size:12px; font-weight:600; opacity:.7; margin-bottom:6px; padding:0 6px; }

    .feed { flex:1; min-height:0; display:flex; flex-direction:column; background: var(--md-sys-color-surface); }
    .feed-header { padding: 18px 20px 12px; border-bottom:1px solid var(--md-sys-color-outline-variant); }
    .feed-header h2 { font-size:18px; font-weight:700; letter-spacing:-0.01em; }
    .feed-header p { margin-top:4px; font-size:13px; line-height:1.6; opacity:.8; }
    .feed-filter { padding: 12px 20px; border-bottom:1px solid var(--md-sys-color-outline-variant); display:flex; flex-direction:column; gap:12px; }
    .feed-filter-top { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .feed-filter-label { font-size:12px; font-weight:600; opacity:.7; }
    .feed-filter-chips { display:flex; flex-wrap:wrap; gap:8px; }
    .feed-sort { display:flex; align-items:center; gap:8px; font-size:12px; font-weight:600; opacity:.75; }
    .feed-sort-select { appearance:none; border-radius: var(--shape-corner-full); border:1px solid var(--md-sys-color-outline-variant); background: var(--md-sys-color-surface-container-low); color: var(--md-sys-color-on-surface); padding: 6px 28px 6px 12px; font-size:13px; font-weight:600; position:relative; min-width:130px; box-shadow: var(--elevation-1); background-image: linear-gradient(45deg, transparent 0%, transparent 70%, color-mix(in oklab, var(--md-sys-color-on-surface) 45%, transparent) 70%), linear-gradient(135deg, transparent 0%, transparent 70%, color-mix(in oklab, var(--md-sys-color-on-surface) 45%, transparent) 70%); background-repeat: no-repeat; background-position: right 12px top 45%, right 6px top 45%; background-size: 8px 8px, 8px 8px; cursor:pointer; }
    .feed-sort-select:focus-visible { outline:3px solid color-mix(in oklab, var(--md-sys-color-primary) 45%, transparent); outline-offset:2px; }
    .feed-list { flex:1; min-height:0; overflow-y:auto; padding: 12px 20px 24px; display:flex; flex-direction:column; gap:16px; }
    .feed-message { padding: 16px 20px; font-size:13px; opacity:.8; }
    .feed-card { border:1px solid var(--md-sys-color-outline-variant); border-radius: var(--shape-corner-xl); background: var(--md-sys-color-surface-container-low); padding: 18px; box-shadow: var(--elevation-1); transition: transform var(--dur-quick) var(--easing-standard), box-shadow var(--dur-quick) var(--easing-standard); }
    .feed-card:hover { transform: translateY(-2px); box-shadow: var(--elevation-3); }
    .feed-card h3 { font-size:17px; font-weight:700; letter-spacing:-0.01em; }
    .feed-meta { display:flex; flex-wrap:wrap; gap:8px 14px; margin-top:10px; font-size:13px; opacity:.85; }
    .feed-desc { margin-top:12px; font-size:14px; line-height:1.6; }
    .feed-footer { margin-top:14px; display:flex; flex-wrap:wrap; gap:8px 14px; font-size:13px; opacity:.8; align-items:center; }
    .feed-card a { color: var(--md-sys-color-primary); font-weight:600; }

    @keyframes blink { 0%,100%{opacity:.25} 50%{opacity:1} }
    .dots>span{ display:inline-block; width:6px; height:6px; border-radius:999px; background: currentColor; animation: blink 1s infinite; }
    .dots>span:nth-child(2){ animation-delay:.18s } .dots>span:nth-child(3){ animation-delay:.36s }

    @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition-duration: 1ms !important; } }
  </style>
</head>
<body>
  <div class="app">
    <header id="appBar" class="app-bar">
      <div class="flex items-center justify-between">
        <div class="brand">
          <div class="brand-badge" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" role="img"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
          </div>
          <div class="brand-title">
            <span class="large" data-i18n="brandLarge">ëŒ€í•œë¯¼êµ­ í–‰ì‚¬ AI íŒŒì¸ë”</span>
            <span class="small" data-i18n="brandSmall">KAIEF</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="paletteBtn" class="icon-button" aria-label="ë¸Œëœë“œ ìƒ‰ ì„¤ì •">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22a5 5 0 01-5-5 7 7 0 117 7z"/><circle cx="6.5" cy="11.5" r="1.5"/><circle cx="9.5" cy="7.5" r="1.5"/><circle cx="14.5" cy="7.5" r="1.5"/><circle cx="17.5" cy="11.5" r="1.5"/></svg>
          </button>
          <button id="themeToggle" class="icon-button theme-toggle" aria-label="í…Œë§ˆ ì „í™˜">
            <svg id="sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
            <svg id="moon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"/></svg>
          </button>
        </div>
      </div>

      <div class="app-controls">
        <div class="tab-group" role="tablist">
          <button id="chatTab" type="button" class="tab active" data-view="chat" role="tab" aria-selected="true" aria-controls="chatView" data-i18n="navChat">AI ì±—ë´‡</button>
          <button id="feedTab" type="button" class="tab" data-view="feed" role="tab" aria-selected="false" aria-controls="feedView" data-i18n="navFeed">í–‰ì‚¬ í”¼ë“œ</button>
        </div>
        <button id="languageToggle" type="button" class="chip language-toggle" aria-label="ì–¸ì–´ ì „í™˜">EN</button>
      </div>

      <div id="brandPanel" class="popover">
        <div class="text-sm font-semibold mb-2">ë¸Œëœë“œ ì»¬ëŸ¬ (ì”¨ì•—) ì„ íƒ</div>
        <div class="flex flex-wrap gap-2 mb-3">
          <button class="chip" data-seed="#6366F1">Indigo (ê¸°ë³¸)</button>
          <button class="chip" data-seed="#0EA5E9">Cyan</button>
          <button class="chip" data-seed="#10B981">Emerald</button>
          <button class="chip" data-seed="#8B5CF6">Purple</button>
        </div>
        <label class="text-sm block mb-2">ì‚¬ìš©ì ì§€ì • ìƒ‰ìƒ</label>
        <div class="flex items-center gap-3">
          <input id="customSeed" type="color" value="#6366F1" class="w-10 h-10 rounded-[12px] border border-[var(--md-sys-color-outline-variant)] bg-[var(--md-sys-color-surface-container)]"/>
          <input id="customSeedHex" type="text" value="#6366F1" class="flex-1 text-sm px-2 py-2 rounded-[10px] border border-[var(--md-sys-color-outline-variant)] bg-[var(--md-sys-color-surface-container-low)]"/>
          <button id="applySeed" class="chip">ì ìš©</button>
        </div>
      </div>
    </header>

    <main class="chat view active" id="chatView" role="tabpanel" aria-labelledby="chatTab">
      <div id="chatList" class="chat-list">
        <div class="flex justify-start">
          <div class="bubble assistant" id="introBubble">
            <div class="assistant-header">
              <div class="w-6 h-6 rounded-full" style="background:linear-gradient(90deg,#34D399,#06B6D4)"></div>
              <span id="introBadge" class="text-xs opacity-70 font-medium">AI ì–´ì‹œìŠ¤í„´íŠ¸</span>
            </div>
            <div id="introText" class="leading-6 text-[15px]">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‰<br/>ëŒ€í•œë¯¼êµ­ì˜ ë‹¤ì–‘í•œ í–‰ì‚¬ì™€ ì´ë²¤íŠ¸ ì •ë³´ë¥¼ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤.</div>
            <div id="introHint" class="text-xs opacity-70 mt-3">ê´€ì‹¬ í‚¤ì›Œë“œë¥¼ ëˆ„ë¥´ë©´ ì§ˆë¬¸ì´ ì…ë ¥ë¼ìš”.</div>
          </div>
        </div>
      </div>

      <div class="composer">
        <div class="chip-label" id="chipLabel" data-i18n="chipLabel">ë¹ ë¥¸ ì§ˆë¬¸</div>
        <div class="chips" id="chips"></div>
        <div class="composer-row">
          <div id="moreWrap" class="relative">
            <button id="moreBtn" class="icon-button" aria-label="ì¶”ê°€ ì˜µì…˜">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
            </button>
            <div id="fabDial" class="fab-dial" aria-label="ë¹ ë¥¸ ì‘ì—… ë©”ë‰´">
              <button class="mini-fab" data-action="attach-file" title="íŒŒì¼ ì²¨ë¶€" aria-label="íŒŒì¼ ì²¨ë¶€">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-8.49 8.49a5 5 0 01-7.07-7.07l8.49-8.49a3 3 0 114.24 4.24l-8.49 8.49a1 1 0 11-1.41-1.41l8.49-8.49"/></svg>
                <span class="fab-label">íŒŒì¼</span>
              </button>
              <button class="mini-fab" data-action="attach-photo" title="ì‚¬ì§„ ì²¨ë¶€" aria-label="ì‚¬ì§„ ì²¨ë¶€">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16v10H4z"/><path d="M9 13l2-2 2 2 3-3 3 3"/></svg>
                <span class="fab-label">ì‚¬ì§„</span>
              </button>
              <button class="mini-fab" data-action="share-location" title="í˜„ì¬ ìœ„ì¹˜ ì¶”ê°€" aria-label="í˜„ì¬ ìœ„ì¹˜ ì¶”ê°€">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="10" r="3"/><path d="M12 2v2m0 12v6m10-10h-2M4 12H2m14.24 5.76l-1.42-1.42M7.17 5.17L5.76 3.76"/></svg>
                <span class="fab-label">ìœ„ì¹˜</span>
              </button>
            </div>
          </div>

          <div class="field">
            <input id="input" class="input" placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”..." maxlength="500" />
          </div>
          <button id="send" class="send" data-compact="true" aria-label="ë©”ì‹œì§€ ì „ì†¡">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3.4 20.4l17.4-8.4c.5-.2.5-.9 0-1.2L3.4 2.4c-.5-.2-1 .2-1 .7v5.5c0 .3.2.6.5.6l8.6.9c.2 0 .2.2 0 .3l-8.6.9c-.3 0-.5.3-.5.6V19.7c0 .5.4 1 1 .7z"/></svg>
            <span class="label" data-i18n="sendLabel">ì „ì†¡</span>
          </button>
        </div>
      </div>
    </main>

    <section class="feed view" id="feedView" role="tabpanel" aria-labelledby="feedTab">
      <div class="feed-header">
        <h2 data-i18n="feedTitle">ì‹¤ì‹œê°„ í–‰ì‚¬ í”¼ë“œ</h2>
        <p data-i18n="feedDescription">êµ­ë¦½ ë¬¸í™”Â·ì˜ˆìˆ  ê¸°ê´€ì˜ ìµœì‹  í–‰ì‚¬ ì†Œì‹ì„ ëª¨ì•„ì„œ ì œê³µí•©ë‹ˆë‹¤.</p>
      </div>
      <div class="feed-filter">
        <div class="feed-filter-top">
          <span class="feed-filter-label" data-i18n="feedFilterLabel">ì£¼ìš” ê¸°ê´€ ë°”ë¡œë³´ê¸°</span>
          <label class="feed-sort" for="feedSort">
            <span data-i18n="feedSortLabel">ì •ë ¬</span>
            <select id="feedSort" class="feed-sort-select">
              <option value="latest" data-i18n-option="feedSortLatest">ìµœì‹ ìˆœ</option>
              <option value="upcoming" data-i18n-option="feedSortUpcoming">ë‹¤ê°€ì˜¤ëŠ” ìˆœ</option>
              <option value="title" data-i18n-option="feedSortTitle">ì´ë¦„ìˆœ</option>
            </select>
          </label>
        </div>
        <div class="feed-filter-chips" id="feedFilters"></div>
      </div>
      <div id="feedMessage" class="feed-message" aria-live="polite"></div>
      <div id="feedList" class="feed-list" role="list"></div>
      <div id="feedFootnote" class="feed-message text-xs opacity-70"></div>
    </section>
  </div>

    <script type="module">
    import { argbFromHex, themeFromSourceColor, applyTheme } from "https://esm.run/@material/material-color-utilities";

    const STORAGE_KEYS = {
      theme: 'kaief_theme',
      seed: 'kaief_seed',
      lang: 'kaief_lang',
      feedSort: 'kaief_feed_sort'
    };

    const translations = {
      ko: {
        brandLarge: "ëŒ€í•œë¯¼êµ­ í–‰ì‚¬ AI íŒŒì¸ë”",
        brandSmall: "KAIEF",
        paletteAria: "ë¸Œëœë“œ ìƒ‰ ì„¤ì •",
        themeAria: "í…Œë§ˆ ì „í™˜",
        navChat: "AI ì±—ë´‡",
        navFeed: "í–‰ì‚¬ í”¼ë“œ",
        languageAria: "ì–¸ì–´ ì „í™˜",
        documentTitle: "KAIEF â€“ ëŒ€í•œë¯¼êµ­ í–‰ì‚¬ AI íŒŒì¸ë”",
        assistantBadge: "AI ì–´ì‹œìŠ¤í„´íŠ¸",
        assistantIntro: "ì•ˆë…•í•˜ì„¸ìš”! ğŸ‰<br/>ëŒ€í•œë¯¼êµ­ì˜ ì£¼ìš” ë¬¸í™”Â·ì˜ˆìˆ  í–‰ì‚¬ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤. ì¼ì •ì´ë‚˜ ê´€ì‹¬ì‚¬ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”!",
        assistantSuggestion: "ê´€ì‹¬ í‚¤ì›Œë“œë¥¼ ëˆ„ë¥´ë©´ ì§ˆë¬¸ì´ ì…ë ¥ë¼ìš”.",
        chipLabel: "ë¹ ë¥¸ ì§ˆë¬¸",
        placeholder: "ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”...",
        sendLabel: "ì „ì†¡",
        sendAria: "ë©”ì‹œì§€ ì „ì†¡",
        moreAria: "ì¶”ê°€ ì˜µì…˜",
        typingLabel: "ì…ë ¥ ì¤‘...",
        keywordTitle: "ğŸ” ì¶”ì¶œëœ í‚¤ì›Œë“œ",
        noEvent: "ê´€ë ¨ëœ í–‰ì‚¬ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”. í‚¤ì›Œë“œë¥¼ ì¡°ê¸ˆ ë°”ê¿”ë³´ì‹œê² ì–´ìš”? (ì˜ˆ: ë‚ ì§œ/ì§€ì—­/ë¶„ì•¼ ì¶”ê°€)",
        errorMessage: "ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
        feedTitle: "ì‹¤ì‹œê°„ í–‰ì‚¬ í”¼ë“œ",
        feedDescription: "êµ­ë¦½ ë¬¸í™”Â·ì˜ˆìˆ  ê¸°ê´€ì˜ ìµœì‹  í–‰ì‚¬ ì†Œì‹ì„ ëª¨ì•„ì„œ ì œê³µí•©ë‹ˆë‹¤.",
        feedFilterLabel: "ì£¼ìš” ê¸°ê´€ ë°”ë¡œë³´ê¸°",
        feedSortLabel: "ì •ë ¬",
        feedSortLatest: "ìµœì‹ ìˆœ",
        feedSortUpcoming: "ë‹¤ê°€ì˜¤ëŠ” ìˆœ",
        feedSortTitle: "ì´ë¦„ìˆœ",
        feedLoading: "í–‰ì‚¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ì—ìš”...",
        feedEmpty: "í˜„ì¬ ì¡°ê±´ì— ë§ëŠ” í–‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ë³€ê²½í•´ë³´ì„¸ìš”.",
        feedError: "í–‰ì‚¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
        feedFootnote: "ë°ì´í„° ì¶œì²˜: ë¬¸í™”ì²´ìœ¡ê´€ê´‘ë¶€ ì‚°í•˜ êµ­ë¦½ê¸°ê´€ ì‹¤ì‹œê°„ ìˆ˜ì§‘",
        chips: [
          { label: "ğŸª ì´ë²ˆ ì£¼ë§ ì¶”ì²œ", prompt: "ì´ë²ˆ ì£¼ë§ì— ê°ˆ ë§Œí•œ ì „êµ­ ë¬¸í™” í–‰ì‚¬ë¥¼ ì¶”ì²œí•´ì¤˜." },
          { label: "ğŸ¨ ë¯¸ìˆ  ì „ì‹œ ì°¾ê¸°", prompt: "êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€ì—ì„œ ì§„í–‰ ì¤‘ì¸ ì „ì‹œë¥¼ ì•Œë ¤ì¤˜." },
          { label: "ğŸ“š ë„ì„œê´€ í”„ë¡œê·¸ë¨", prompt: "êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ì—ì„œ ì°¸ì—¬í•  ìˆ˜ ìˆëŠ” ì²´í—˜ì´ë‚˜ ê°•ì—°ì´ ìˆì„ê¹Œ?" },
          { label: "ğŸµ êµ­ì•… ê³µì—°", prompt: "êµ­ë¦½êµ­ì•…ì›ì—ì„œ ê³§ ì§„í–‰ë˜ëŠ” ê³µì—°ì„ ì•Œë ¤ì¤˜." }
        ],
        eventLabels: {
          category: "ë¶„ë¥˜",
          schedule: "ì¼ì •",
          location: "ì¥ì†Œ",
          host: "ì£¼ê´€",
          status: "ìƒíƒœ",
          cost: "ì°¸ê°€ë¹„"
        },
        actions: {
          viewDetail: "ìì„¸íˆ ë³´ê¸°"
        },
        costFree: "ë¬´ë£Œ",
        unknownTitle: "ì œëª© ë¯¸ìƒ",
        unknownValue: "ì •ë³´ ì—†ìŒ"
      },
      en: {
        brandLarge: "Korea Event AI Finder",
        brandSmall: "KAIEF",
        paletteAria: "Set brand color",
        themeAria: "Toggle theme",
        navChat: "AI Chatbot",
        navFeed: "Event feed",
        languageAria: "Switch language",
        documentTitle: "KAIEF â€“ Korea Event AI Finder",
        assistantBadge: "AI Assistant",
        assistantIntro: "Hello! ğŸ‰<br/>I surface cultural and arts events across Korea in real time. Tell me about your schedule or interests!",
        assistantSuggestion: "Tap a quick prompt to pre-fill your question.",
        chipLabel: "Quick prompts",
        placeholder: "Ask anything about events...",
        sendLabel: "Send",
        sendAria: "Send message",
        moreAria: "More options",
        typingLabel: "Typing...",
        keywordTitle: "ğŸ” Extracted keywords",
        noEvent: "I couldn't find a matching event. Try adding date, region, or theme keywords.",
        errorMessage: "Something went wrong. Please try again in a moment.",
        feedTitle: "Live event feed",
        feedDescription: "Fresh cultural and arts programs curated from national institutions across Korea.",
        feedFilterLabel: "Featured institutions",
        feedSortLabel: "Sort",
        feedSortLatest: "Newest first",
        feedSortUpcoming: "Upcoming",
        feedSortTitle: "Aâ€“Z",
        feedLoading: "Loading event data...",
        feedEmpty: "No events match the current filter. Try another option.",
        feedError: "Unable to load event data right now. Please try again later.",
        feedFootnote: "Sources: Ministry of Culture, Sports and Tourism national institutions",
        chips: [
          { label: "ğŸª Weekend picks", prompt: "What cultural events this weekend are worth visiting around Korea?" },
          { label: "ğŸ¨ Exhibition finder", prompt: "Show me exhibitions currently running at the National Museum of Modern and Contemporary Art." },
          { label: "ğŸ“š Library programs", prompt: "Are there any workshops or lectures at the National Library of Korea?" },
          { label: "ğŸµ Gugak performance", prompt: "Which performances are coming up at the National Gugak Center?" }
        ],
        eventLabels: {
          category: "Category",
          schedule: "Schedule",
          location: "Location",
          host: "Organizer",
          status: "Status",
          cost: "Admission"
        },
        actions: {
          viewDetail: "View details"
        },
        costFree: "Free",
        unknownTitle: "Untitled event",
        unknownValue: "Not available"
      }
    };

    const feedFilterOptions = [
      { id: 'all', label: { ko: 'ì „ì²´', en: 'All' } },
      { id: 'nmok', label: { ko: 'êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€', en: 'National Museum of Korea' }, match: ['êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€'] },
      { id: 'nlib', label: { ko: 'êµ­ë¦½ì¤‘ì•™ë„ì„œê´€', en: 'National Library of Korea' }, match: ['êµ­ë¦½ì¤‘ì•™ë„ì„œê´€'] },
      { id: 'mmca', label: { ko: 'êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€', en: 'MMCA' }, match: ['êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€'] },
      { id: 'gugak', label: { ko: 'êµ­ë¦½êµ­ì•…ì›', en: 'National Gugak Center' }, match: ['êµ­ë¦½êµ­ì•…ì›'] },
      { id: 'folk', label: { ko: 'êµ­ë¦½ë¯¼ì†ë°•ë¬¼ê´€', en: 'National Folk Museum' }, match: ['êµ­ë¦½ë¯¼ì†ë°•ë¬¼ê´€'] }
    ];

    const root = document.documentElement;
    const appBar = document.getElementById('appBar');
    const themeToggle = document.getElementById('themeToggle');
    const sun = document.getElementById('sun');
    const moon = document.getElementById('moon');
    const paletteBtn = document.getElementById('paletteBtn');
    const brandPanel = document.getElementById('brandPanel');
    const customSeed = document.getElementById('customSeed');
    const customSeedHex = document.getElementById('customSeedHex');
    const applySeed = document.getElementById('applySeed');
    const languageToggle = document.getElementById('languageToggle');
    const tabButtons = document.querySelectorAll('.tab-group [data-view]');
    const chatView = document.getElementById('chatView');
    const feedView = document.getElementById('feedView');
    const chatList = document.getElementById('chatList');
    const feedList = document.getElementById('feedList');
    const feedMessage = document.getElementById('feedMessage');
    const feedFootnote = document.getElementById('feedFootnote');
    const feedFiltersEl = document.getElementById('feedFilters');
    const feedSortSelect = document.getElementById('feedSort');
    const chips = document.getElementById('chips');
    const chipLabel = document.getElementById('chipLabel');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const moreBtn = document.getElementById('moreBtn');
    const moreWrap = document.getElementById('moreWrap');
    const fabDial = document.getElementById('fabDial');
    const introBadge = document.getElementById('introBadge');
    const introText = document.getElementById('introText');
    const introHint = document.getElementById('introHint');

    let currentLang = localStorage.getItem(STORAGE_KEYS.lang) === 'en' ? 'en' : 'ko';
    let currentSeed = localStorage.getItem(STORAGE_KEYS.seed) || '#6366F1';
    let currentView = 'chat';
    let dialOpen = false;
    let typingEl = null;
    const FEED_SORT_OPTIONS = ['latest', 'upcoming', 'title'];
    const DEFAULT_FEED_SORT = FEED_SORT_OPTIONS[0];
    let activeFeedSort = localStorage.getItem(STORAGE_KEYS.feedSort) || DEFAULT_FEED_SORT;
    if (!FEED_SORT_OPTIONS.includes(activeFeedSort)) {
      activeFeedSort = DEFAULT_FEED_SORT;
    }

    let feedLoaded = false;
    let cachedEvents = [];
    let activeFeedFilter = 'all';

    function isDark() {
      return root.getAttribute('data-theme') === 'dark';
    }

    function applyThemeFromSeed(hex) {
      try {
        const theme = themeFromSourceColor(argbFromHex(hex));
        applyTheme(theme, { target: root, dark: isDark() });
        document.documentElement.style.setProperty(
          '--gradient-primary',
          `linear-gradient(135deg, var(--md-sys-color-primary) 0%, color-mix(in oklab, var(--md-sys-color-primary) 85%, #ffffff) 50%, color-mix(in oklab, var(--md-sys-color-primary) 70%, #ffffff) 100%)`
        );
        currentSeed = hex;
        localStorage.setItem(STORAGE_KEYS.seed, hex);
      } catch (e) {
        console.warn('Dynamic color apply failed', e);
      }
    }

    function applyThemeMode(theme) {
      root.setAttribute('data-theme', theme);
      localStorage.setItem(STORAGE_KEYS.theme, theme);
      const dark = theme === 'dark';
      sun.style.display = dark ? 'none' : 'block';
      moon.style.display = dark ? 'block' : 'none';
      applyThemeFromSeed(currentSeed);
    }

    applyThemeMode(localStorage.getItem(STORAGE_KEYS.theme) || 'light');
    applyThemeFromSeed(currentSeed);

    themeToggle.addEventListener('click', () => {
      applyThemeMode(isDark() ? 'light' : 'dark');
    });

    function togglePanel() {
      brandPanel.classList.toggle('open');
    }

    paletteBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      togglePanel();
    });

    document.addEventListener('click', (e) => {
      if (!brandPanel.contains(e.target) && e.target !== paletteBtn) {
        brandPanel.classList.remove('open');
      }
      if (dialOpen && !moreWrap.contains(e.target)) {
        toggleDial(false);
      }
    });

    brandPanel.addEventListener('click', (e) => {
      const btn = e.target.closest('.chip');
      if (btn && btn.dataset.seed) {
        customSeed.value = btn.dataset.seed;
        customSeedHex.value = btn.dataset.seed;
        applyThemeFromSeed(btn.dataset.seed);
      }
    });

    customSeed.addEventListener('input', () => {
      customSeedHex.value = customSeed.value;
    });

    customSeedHex.addEventListener('input', () => {
      if (/^#([0-9a-fA-F]{6})$/.test(customSeedHex.value)) {
        customSeed.value = customSeedHex.value;
      }
    });

    applySeed.addEventListener('click', () => {
      if (/^#([0-9a-fA-F]{6})$/.test(customSeed.value)) {
        applyThemeFromSeed(customSeed.value);
      }
    });

    function escapeHTML(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
    }

    function trimText(value, limit = 600) {
      const raw = String(value ?? '').trim();
      if (!raw) return '';
      if (raw.length <= limit) return raw;
      return `${raw.slice(0, limit)}â€¦`;
    }

    function formatDescription(value, limit = 600) {
      const trimmed = trimText(value, limit);
      if (!trimmed) return '';
      return escapeHTML(trimmed).replace(/\n+/g, '<br/>');
    }

    function formatCost(value, lang) {
      if (value === null || value === undefined) return '';
      const trimmed = String(value).trim();
      if (!trimmed) return '';
      if (['0', 'ë¬´ë£Œ', 'free'].includes(trimmed.toLowerCase())) {
        return escapeHTML(translations[lang].costFree);
      }
      return escapeHTML(trimmed);
    }

    function formatMultiline(text) {
      if (!text) return '';
      return escapeHTML(String(text)).replace(/\n+/g, '<br/>');
    }

    function escapeValue(value, fallback = '') {
      const raw = value ?? '';
      const text = String(raw).trim();
      if (!text) {
        return fallback ? escapeHTML(fallback) : '';
      }
      return escapeHTML(text);
    }

    function extractEvent(ev, lang, options = {}) {
      if (!ev || typeof ev !== 'object') return null;
      const t = translations[lang];
      const limit = options.descriptionLimit ?? 600;
      return {
        title: escapeValue(ev.title, t.unknownTitle),
        category: escapeValue(ev.category),
        schedule: escapeValue(ev.period || ev.date || ev.datetime),
        location: escapeValue(ev.place || ev.location),
        host: escapeValue(ev.host || ev.organization),
        status: escapeValue(ev.state || ev.status),
        cost: formatCost(ev.cost, lang),
        description: formatDescription(ev.deep_data || ev.description || ev.overview || '', limit),
        link: escapeValue(ev.url || '')
      };
    }

    function assistantHeaderHTML() {
      return `<div class="assistant-header"><div class="w-6 h-6 rounded-full" style="background:linear-gradient(90deg,#34D399,#06B6D4)"></div><span class="text-xs opacity-70 font-medium">${translations[currentLang].assistantBadge}</span></div>`;
    }

    function renderEventCard(ev, options = {}) {
      const lang = options.lang || currentLang;
      const t = translations[lang];
      if (!ev || Object.keys(ev).length === 0) {
        return `<div class="text-sm opacity-80">${t.noEvent}</div>`;
      }
      const data = extractEvent(ev, lang, options);
      if (!data) {
        return `<div class="text-sm opacity-80">${t.noEvent}</div>`;
      }
      const infoParts = [];
      if (data.category) infoParts.push(`ğŸ“‚ ${t.eventLabels.category}: ${data.category}`);
      if (data.schedule) infoParts.push(`ğŸ“… ${t.eventLabels.schedule}: ${data.schedule}`);
      if (data.location) infoParts.push(`ğŸ“ ${t.eventLabels.location}: ${data.location}`);
      const metaParts = [];
      if (data.host) metaParts.push(`ğŸ¢ ${t.eventLabels.host}: ${data.host}`);
      if (data.status) metaParts.push(`ğŸ“Œ ${t.eventLabels.status}: ${data.status}`);
      if (data.cost) metaParts.push(`ğŸ’° ${t.eventLabels.cost}: ${data.cost}`);
      const link = options.showLink && data.link ? `<a href="${data.link}" target="_blank" rel="noopener">${t.actions.viewDetail}</a>` : '';
      return `
        <div class="${options.wrapperClass || 'mt-2 p-3 rounded-[16px] border border-[var(--md-sys-color-outline-variant)] bg-[var(--md-sys-color-surface-container-low)] shadow-sm'}">
          <div class="text-base font-semibold mb-1" style="letter-spacing:-0.01em">${data.title}</div>
          ${infoParts.length ? `<div class="flex flex-wrap gap-x-3 gap-y-1 text-sm opacity-80">${infoParts.map((p) => `<div>${p}</div>`).join('')}</div>` : ''}
          ${metaParts.length ? `<div class="flex flex-wrap gap-x-3 gap-y-1 text-xs mt-3 opacity-70">${metaParts.map((p) => `<div>${p}</div>`).join('')}</div>` : ''}
          ${data.description ? `<div class="mt-3 text-sm leading-6">${data.description}</div>` : ''}
          ${link ? `<div class="mt-3 text-sm font-semibold">${link}</div>` : ''}
        </div>
      `;
    }

    function renderKeywords(kw = []) {
      if (!Array.isArray(kw) || kw.length === 0) return '';
      const pills = kw.slice(0, 8).map((k) => `<span class="px-2 py-1 rounded-full border border-[var(--md-sys-color-outline-variant)] bg-[var(--md-sys-color-surface-container)] text-xs">${escapeHTML(k)}</span>`).join(' ');
      return `<div class="mt-2 flex flex-wrap gap-1 items-center">${pills}</div>`;
    }

    function addBubble(role, html) {
      const row = document.createElement('div');
      row.className = 'flex ' + (role === 'user' ? 'justify-end' : 'justify-start');
      row.innerHTML = `<div class="bubble ${role}">${html}</div>`;
      chatList.appendChild(row);
      chatList.scrollTo({ top: chatList.scrollHeight, behavior: 'smooth' });
    }

    function showTyping() {
      hideTyping();
      const row = document.createElement('div');
      row.className = 'flex justify-start';
      const t = translations[currentLang];
      row.innerHTML = `
        <div class="bubble assistant">
          ${assistantHeaderHTML()}
          <div class="text-xs opacity-70 mb-2">${t.typingLabel}</div>
          <div class="dots"><span></span><span></span><span></span></div>
        </div>
      `;
      typingEl = row;
      chatList.appendChild(row);
      chatList.scrollTo({ top: chatList.scrollHeight, behavior: 'smooth' });
    }

    function hideTyping() {
      if (typingEl) {
        typingEl.remove();
        typingEl = null;
      }
    }

    function updateSend() {
      const hasText = input.value.trim().length > 0;
      send.setAttribute('data-compact', hasText ? 'false' : 'true');
      const labelEl = send.querySelector('.label');
      if (labelEl) labelEl.setAttribute('aria-hidden', hasText ? 'false' : 'true');
    }

    input.addEventListener('input', updateSend);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
        e.preventDefault();
        sendMessage();
      }
    });
    send.addEventListener('click', sendMessage);

    chips.addEventListener('click', (e) => {
      const btn = e.target.closest('.chip');
      if (!btn) return;
      input.value = btn.dataset.text || '';
      updateSend();
      input.focus();
    });

    function buildAssistantResponse(payload) {
      const t = translations[currentLang];
      const keywords = Array.isArray(payload.keywords) ? payload.keywords : [];
      const reasonData = payload.reason;
      const reasonText = typeof reasonData === 'string'
        ? reasonData
        : (reasonData?.[currentLang] || reasonData?.ko || '');
      let html = assistantHeaderHTML();
      if (keywords.length) {
        html += `<div class="text-sm opacity-70 mb-1">${t.keywordTitle}</div>${renderKeywords(keywords)}`;
      }
      if (reasonText) {
        html += `<div class="mt-3 text-sm leading-6">${formatMultiline(reasonText)}</div>`;
      }
      html += renderEventCard(payload.recommended_event || {}, { showLink: true });
      return html;
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      addBubble('user', escapeHTML(text));
      input.value = '';
      updateSend();
      showTyping();

      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        hideTyping();
        const rawResponse = data?.response;
        let responsePayload = {};
        if (rawResponse && typeof rawResponse === 'object') {
          responsePayload = rawResponse;
        } else if (typeof rawResponse === 'string') {
          responsePayload = { reason: { ko: rawResponse, en: rawResponse }, recommended_event: {} };
        }
        const html = buildAssistantResponse(responsePayload);
        addBubble('assistant', html);
      } catch (err) {
        hideTyping();
        const t = translations[currentLang];
        addBubble('assistant', `
          ${assistantHeaderHTML()}
          <div class="text-sm">${t.errorMessage}</div>
          <div class="mt-2 text-xs opacity-70">${escapeHTML(String(err))}</div>
        `);
      }
    }

    function updateLanguageToggle() {
      languageToggle.textContent = currentLang === 'ko' ? 'EN' : 'KO';
      languageToggle.setAttribute('lang', currentLang === 'ko' ? 'en' : 'ko');
      languageToggle.setAttribute('aria-label', translations[currentLang].languageAria);
    }

    function updateIntroBubble() {
      const t = translations[currentLang];
      introBadge.textContent = t.assistantBadge;
      introText.innerHTML = t.assistantIntro;
      introHint.textContent = t.assistantSuggestion;
    }

    function renderChips() {
      chips.innerHTML = '';
      const presets = translations[currentLang].chips || [];
      presets.forEach((preset) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chip';
        btn.dataset.text = preset.prompt;
        btn.textContent = preset.label;
        chips.appendChild(btn);
      });
    }

    if (feedSortSelect) {
      feedSortSelect.value = activeFeedSort;
      feedSortSelect.addEventListener('change', () => {
        const value = feedSortSelect.value;
        activeFeedSort = FEED_SORT_OPTIONS.includes(value) ? value : DEFAULT_FEED_SORT;
        localStorage.setItem(STORAGE_KEYS.feedSort, activeFeedSort);
        if (feedList) {
          feedList.scrollTop = 0;
        }
        renderFeed();
      });
    }

    function renderFeedFilters() {
      if (!feedFiltersEl) return;
      feedFiltersEl.innerHTML = '';
      feedFilterOptions.forEach((option) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chip';
        btn.dataset.filterId = option.id;
        btn.dataset.active = option.id === activeFeedFilter ? 'true' : 'false';
        btn.textContent = option.label[currentLang] || option.label.ko;
        btn.addEventListener('click', () => {
          activeFeedFilter = option.id;
          renderFeedFilters();
          renderFeed();
        });
        feedFiltersEl.appendChild(btn);
      });
    }

    function filterEventsByActiveOption(events) {
      const option = feedFilterOptions.find((opt) => opt.id === activeFeedFilter);
      if (!option || !option.match || option.match.length === 0) {
        return events.slice();
      }
      const keywords = option.match.map((m) => m.toLowerCase());
      return events.filter((ev) => {
        const haystack = `${ev.host || ''} ${ev.organization || ''} ${ev.title || ''}`.toLowerCase();
        return keywords.some((keyword) => haystack.includes(keyword));
      });
    }

    const EVENT_DATE_FIELDS = [
      'datetime',
      'date',
      'period',
      'schedule',
      'start_date',
      'startDate',
      'start',
      'begin',
      'beginDate',
      'from',
      'reg_dt',
      'regDate',
      'created_at',
      'createdAt',
      'updated_at',
      'updatedAt',
      'timestamp',
      'published_at',
      'publishedAt',
      'open_date',
      'openDate',
      'end_date',
      'endDate',
      'end',
      'close_date',
      'closeDate'
    ];

    const EVENT_NESTED_DATE_KEYS = [
      'start',
      'start_date',
      'startDate',
      'begin',
      'beginDate',
      'from',
      'end',
      'end_date',
      'endDate',
      'close',
      'close_date',
      'closeDate',
      'timestamp',
      'date'
    ];

    const eventTimeCache = new WeakMap();

    function isFiniteNumber(value) {
      return typeof value === 'number' && Number.isFinite(value);
    }

    function collectTimeCandidates(value, bucket) {
      if (!value) return;
      if (typeof value === 'number') {
        if (isFiniteNumber(value) && value > 0) {
          bucket.push(value);
        }
        return;
      }
      if (value instanceof Date) {
        bucket.push(value.getTime());
        return;
      }
      if (Array.isArray(value)) {
        value.forEach((item) => collectTimeCandidates(item, bucket));
        return;
      }
      if (typeof value === 'object') {
        EVENT_NESTED_DATE_KEYS.forEach((key) => {
          if (value && key in value) {
            collectTimeCandidates(value[key], bucket);
          }
        });
        return;
      }
      const text = String(value).trim();
      if (!text) return;
      const yearMatches = text.matchAll(/(20\d{2})[.\-\/\së…„]*(\d{1,2})[.\-\/\sì›”]*(\d{1,2})/g);
      for (const match of yearMatches) {
        const year = Number(match[1]);
        const month = Number(match[2]);
        const day = Number(match[3]);
        if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
          bucket.push(new Date(year, month - 1, day).getTime());
        }
      }
      const compact = text.match(/(20\d{2})(\d{2})(\d{2})/);
      if (compact) {
        const year = Number(compact[1]);
        const month = Number(compact[2]);
        const day = Number(compact[3]);
        if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
          bucket.push(new Date(year, month - 1, day).getTime());
        }
      }
      const parsed = Date.parse(text);
      if (isFiniteNumber(parsed)) {
        bucket.push(parsed);
      }
    }

    function getEventTimeRange(ev) {
      if (!ev || typeof ev !== 'object') {
        return { earliest: null, latest: null };
      }
      if (eventTimeCache.has(ev)) {
        return eventTimeCache.get(ev);
      }
      const times = [];
      EVENT_DATE_FIELDS.forEach((field) => {
        if (field in ev) {
          collectTimeCandidates(ev[field], times);
        }
      });
      if (Array.isArray(ev.dates)) {
        collectTimeCandidates(ev.dates, times);
      }
      const earliest = times.length ? Math.min(...times) : null;
      const latest = times.length ? Math.max(...times) : null;
      const result = { earliest, latest };
      eventTimeCache.set(ev, result);
      return result;
    }

    function compareAlphabetically(a, b, locale) {
      const hostA = String(a.host || a.organization || '');
      const hostB = String(b.host || b.organization || '');
      const titleA = String(a.title || '');
      const titleB = String(b.title || '');
      const hostCompare = hostA.localeCompare(hostB, locale, { sensitivity: 'base' });
      if (hostCompare !== 0) return hostCompare;
      return titleA.localeCompare(titleB, locale, { sensitivity: 'base' });
    }

    function sortEventsByMode(a, b, mode, locale) {
      if (mode === 'latest') {
        const rangeA = getEventTimeRange(a);
        const rangeB = getEventTimeRange(b);
        const aLatest = isFiniteNumber(rangeA.latest) ? rangeA.latest : -Infinity;
        const bLatest = isFiniteNumber(rangeB.latest) ? rangeB.latest : -Infinity;
        if (aLatest !== bLatest) {
          return bLatest - aLatest;
        }
        return compareAlphabetically(a, b, locale);
      }
      if (mode === 'upcoming') {
        const rangeA = getEventTimeRange(a);
        const rangeB = getEventTimeRange(b);
        const aEarliest = isFiniteNumber(rangeA.earliest) ? rangeA.earliest : Infinity;
        const bEarliest = isFiniteNumber(rangeB.earliest) ? rangeB.earliest : Infinity;
        if (aEarliest !== bEarliest) {
          return aEarliest - bEarliest;
        }
        return compareAlphabetically(a, b, locale);
      }
      return compareAlphabetically(a, b, locale);
    }

    function createFeedCard(ev) {
      const data = extractEvent(ev, currentLang, { descriptionLimit: 420 });
      if (!data) return null;
      const t = translations[currentLang];
      const card = document.createElement('article');
      card.className = 'feed-card';
      const infoParts = [];
      if (data.category) infoParts.push(`ğŸ“‚ ${data.category}`);
      if (data.schedule) infoParts.push(`ğŸ“… ${data.schedule}`);
      if (data.location) infoParts.push(`ğŸ“ ${data.location}`);
      const infoHTML = infoParts.length ? `<div class="feed-meta">${infoParts.map((p) => `<span>${p}</span>`).join('')}</div>` : '';
      const metaParts = [];
      if (data.host) metaParts.push(`ğŸ¢ ${data.host}`);
      if (data.status) metaParts.push(`ğŸ“Œ ${data.status}`);
      if (data.cost) metaParts.push(`ğŸ’° ${data.cost}`);
      const footerSegments = [];
      if (metaParts.length) {
        footerSegments.push(`<span>${metaParts.join(' Â· ')}</span>`);
      }
      if (data.link) {
        footerSegments.push(`<a href="${data.link}" target="_blank" rel="noopener">${t.actions.viewDetail}</a>`);
      }
      const footerHTML = footerSegments.length ? `<div class="feed-footer">${footerSegments.join('')}</div>` : '';
      card.innerHTML = `
        <h3>${data.title}</h3>
        ${infoHTML}
        ${data.description ? `<div class="feed-desc">${data.description}</div>` : ''}
        ${footerHTML}
      `;
      return card;
    }

    function renderFeed() {
      if (!feedLoaded) return;
      const t = translations[currentLang];
      const filtered = filterEventsByActiveOption(cachedEvents);
      feedList.innerHTML = '';
      if (filtered.length === 0) {
        feedMessage.textContent = t.feedEmpty;
        feedFootnote.textContent = t.feedFootnote;
        return;
      }
      feedMessage.textContent = '';
      const locale = currentLang === 'ko' ? 'ko' : 'en';
      const sortMode = FEED_SORT_OPTIONS.includes(activeFeedSort) ? activeFeedSort : DEFAULT_FEED_SORT;
      const sorted = filtered.slice().sort((a, b) => sortEventsByMode(a, b, sortMode, locale));
      sorted.forEach((ev) => {
        const card = createFeedCard(ev);
        if (card) feedList.appendChild(card);
      });
      feedFootnote.textContent = t.feedFootnote;
    }

    async function ensureFeed(forceReload = false) {
      const t = translations[currentLang];
      if (feedLoaded && !forceReload) {
        renderFeed();
        return;
      }
      feedMessage.textContent = t.feedLoading;
      try {
        const res = await fetch('/events');
        const data = await res.json();
        cachedEvents = Array.isArray(data.events) ? data.events : [];
        feedLoaded = true;
        renderFeed();
      } catch (err) {
        console.error('Failed to load events', err);
        feedMessage.textContent = t.feedError;
        feedFootnote.textContent = '';
      }
    }

    function handleSurfaceScroll(target) {
      if (!target) return;
      const shouldCompact = target.scrollTop > 6;
      appBar.classList.toggle('compact', shouldCompact);
    }

    function switchView(view) {
      if (view !== 'chat' && view !== 'feed') return;
      currentView = view;
      tabButtons.forEach((btn) => {
        const isActive = btn.dataset.view === view;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      chatView.classList.toggle('active', view === 'chat');
      feedView.classList.toggle('active', view === 'feed');
      if (view === 'chat') {
        handleSurfaceScroll(chatList);
      } else {
        ensureFeed();
        handleSurfaceScroll(feedList);
      }
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener('click', () => switchView(btn.dataset.view));
    });

    function applyLanguage(lang) {
      currentLang = lang === 'en' ? 'en' : 'ko';
      localStorage.setItem(STORAGE_KEYS.lang, currentLang);
      document.documentElement.lang = currentLang === 'ko' ? 'ko' : 'en';
      const t = translations[currentLang];
      document.title = t.documentTitle;
      document.querySelectorAll('[data-i18n]').forEach((el) => {
        const key = el.dataset.i18n;
        if (t[key]) {
          el.textContent = t[key];
        }
      });
      if (feedSortSelect) {
        feedSortSelect.querySelectorAll('option[data-i18n-option]').forEach((opt) => {
          const key = opt.dataset.i18nOption;
          if (t[key]) {
            opt.textContent = t[key];
          }
        });
        feedSortSelect.value = FEED_SORT_OPTIONS.includes(activeFeedSort) ? activeFeedSort : DEFAULT_FEED_SORT;
      }
      input.placeholder = t.placeholder;
      input.setAttribute('aria-label', t.placeholder);
      const labelEl = send.querySelector('.label');
      if (labelEl) labelEl.textContent = t.sendLabel;
      send.setAttribute('aria-label', t.sendAria);
      paletteBtn.setAttribute('aria-label', t.paletteAria);
      themeToggle.setAttribute('aria-label', t.themeAria);
      moreBtn.setAttribute('aria-label', t.moreAria);
      updateLanguageToggle();
      updateIntroBubble();
      renderChips();
      renderFeedFilters();
      if (feedLoaded) {
        renderFeed();
      } else {
        feedMessage.textContent = '';
        feedFootnote.textContent = '';
      }
    }

    languageToggle.addEventListener('click', () => {
      applyLanguage(currentLang === 'ko' ? 'en' : 'ko');
    });

    function toggleDial(force) {
      dialOpen = typeof force === 'boolean' ? force : !dialOpen;
      fabDial.classList.toggle('open', dialOpen);
    }

    moreBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleDial();
    });

    chatList.addEventListener('scroll', () => {
      if (currentView === 'chat') handleSurfaceScroll(chatList);
    });

    feedList.addEventListener('scroll', () => {
      if (currentView === 'feed') handleSurfaceScroll(feedList);
    });

    const ro = new ResizeObserver(() => {
      toggleDial(false);
    });
    ro.observe(document.body);

    applyLanguage(currentLang);
    updateSend();
    handleSurfaceScroll(chatList);
  </script>

</body>
</html>
